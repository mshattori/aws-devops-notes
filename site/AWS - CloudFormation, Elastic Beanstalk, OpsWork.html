<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>AWS - CloudFormation, Elastic Beanstalk, OpsWork - AWS DevOps Notes</title>
    <link rel="stylesheet" href="static/style.css">
</head>
<body>
    
    <header>
        <h1>AWS - CloudFormation, Elastic Beanstalk, OpsWork</h1>
    </header>
    
    <main>
        
<article>
    <h2 id="infrastructure-as-code">プロビジョニング・デプロイ自動化と Infrastructure as Code</h2>
<p><img alt="" src="_attachment/Pasted%20image%2020251108200401.png" /></p>
<table>
<thead>
<tr>
<th>サービス名</th>
<th>目的</th>
<th>動作概要</th>
<th>主要対象リソース</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>CloudFormation</strong></td>
<td>AWS インフラの自動構成</td>
<td>JSON または YAML で記述されたテンプレートから AWS リソースを自動で作成・削除する</td>
<td>VPC, EC2, Auto Scaling, S3, IAM など多くの AWS サービス</td>
</tr>
<tr>
<td><strong>Elastic Beanstalk</strong></td>
<td>Web アプリ実行環境の自動構成</td>
<td>ソースコードや Docker コンテナをアップロードすると、ランタイム環境やサーバを自動で構築・デプロイする</td>
<td>EC2, Auto Scaling, ELB, RDS, CloudWatch など</td>
</tr>
<tr>
<td><strong>OpsWorks</strong><br></td>
<td>Chef/Puppet を用いたサーバ設定管理</td>
<td>レイヤーとスタックの概念を用いてサーバ構成を自動化。レシピに従いアプリやミドルウェアをインストールする</td>
<td>EC2, ELB, Auto Scaling、オンプレミスサーバも管理可能</td>
</tr>
</tbody>
</table>
<ul>
<li>CloudFormation は AWS リソースのプロビジョニングに特化。<ul>
<li>ソフトウェアのデプロイやアップデートなどはしない。</li>
</ul>
</li>
<li>Beanstalk, OpsWorks はインフラのプロビジョニング、アプリケーションのデプロイ、運用時のモニタリングまで全体をカバー。<ul>
<li>Web アプリの定番構成 → Beanstalk</li>
<li>Web アプリでない、定番構成でない、既に Chef/Puppet 使っている → OpsWork</li>
</ul>
</li>
<li>CloudFormation + Beanstalk/OpsWork との組み合わせもできる</li>
</ul>
<hr />
<h1 id="aws-cloudformation">AWS CloudFormation</h1>
<ul>
<li>AWS サービスのプロビジョニングを実施するサービス。<ul>
<li>EC2、ELB、RDS などの AWS リソース環境を自動でセットアップ。</li>
</ul>
</li>
<li>テキストファイルによるテンプレート記述。<ul>
<li>JSON または YAML で記述。</li>
<li>テンプレートをバージョン管理することで IaC を実現。</li>
</ul>
</li>
<li>無料。</li>
</ul>
<h2 id="cloudformation">CloudFormation テンプレート</h2>
<ul>
<li>JSON or YAML 形式。<ul>
<li>変装をパラメータとして渡せる。</li>
<li>テンプレートは S3 にアップロードする必要がある。</li>
</ul>
</li>
<li>CloudFormation デザイナー<ul>
<li>テンプレート作成の GUI ツール。リソースをドラッグ&amp;ドロップして編集。</li>
</ul>
</li>
</ul>
<p><img alt="" src="_attachment/File_274.png" /></p>
<ul>
<li><a href="https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/working-with-templates-cfn-designer-overview.html">https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/working-with-templates-cfn-designer-overview.html</a></li>
<li>テンプレートスニペット<ul>
<li>AWS の各種リソースのテンプレート例 (JSON/YAML)</li>
<li><a href="https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/CHAP_TemplateQuickRef.html">https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/CHAP_TemplateQuickRef.html</a></li>
</ul>
</li>
</ul>
<p>テンプレートの項目</p>
<pre><code>AWSTemplateFormatVersion: '2010-09-09'
Description: 説明を記述する
Parameters:
  # パラメータ定義
Mappings:
  # マッピング定義
Conditions:
  # 条件定義
Resources:
  # リソース定義
Outputs:
  # 出力定義
</code></pre>
<ul>
<li><strong>AWSTemplateFormatVersion</strong> (オプション) … テンプレートのフォーマットバージョン。</li>
<li><strong>Description</strong> (オプション) … テンプレートの説明文。</li>
<li><strong>Parameters</strong> (オプション) … テンプレート外から受け取る入力値を定義する。</li>
<li><strong>Mappings</strong> (オプション) … リージョンや環境に応じた定数をマッピングする。</li>
<li><strong>Conditions</strong> (オプション) … リソース作成の条件を定義するための論理式。</li>
<li><strong>Transform</strong> (オプション) … マクロや AWS SAM テンプレートを利用する場合に指定。</li>
<li><strong>Resources</strong> (必須) … 作成する AWS リソースを定義する部分。</li>
<li><strong>Outputs</strong> (オプション) … 他スタックにエクスポートしたい値や出力を定義する。</li>
</ul>
<h3 id="parameters">Parameters</h3>
<pre><code>Parameters:
  InstanceTypeParameter:
    Type: String
    Default: t2.small
    AllowedValues:
      - t2.small
      - a1.xlarge
      - t3a.xlarge
      - c5n.xlarge
    Description: Amazon EC2 instance type

</code></pre>
<ul>
<li><strong>Type:</strong><ul>
<li>String</li>
<li>Number</li>
<li>CommaDelimitedList</li>
<li>List\&lt;Type&gt;</li>
<li>AWS 特有のタイプ (例: AWS::EC2::KeyPair::KeyName など)</li>
</ul>
</li>
<li><strong>Description</strong> ... 説明文</li>
<li><strong>Constraints</strong> ... 制約条件<ul>
<li>ConstraintDescription (String)<ul>
<li>Constraints がエラーになった場合にエラーメッセージとして出力する文字列。</li>
</ul>
</li>
<li>Min/MaxLength</li>
<li>Min/MaxValue</li>
<li>Defaults</li>
<li>AllowedValues (array)</li>
<li>AllowedPattern (regexp)</li>
<li>NoEcho (Boolean)<ul>
<li>パラメタ値をコンソールや CLI 出力でマスクするかを指定。</li>
</ul>
</li>
</ul>
</li>
<li><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/parameters-section-structure.html">https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/parameters-section-structure.html</a></li>
</ul>
<p><strong>パラメータ検証</strong></p>
<ul>
<li><strong>AllowedPattern</strong>: 正規表現による入力制約<ul>
<li>例: IPv4/CIDR 用のパターン <code>'^(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})'$</code></li>
</ul>
</li>
<li><strong>AllowedValues</strong>: あらかじめ許可する文字列を列挙<ul>
<li>例: <code>[ 't2.micro', 't2.small', 'i3.16xlarge' ]</code></li>
</ul>
</li>
<li><strong>Parameter Type</strong>:  AWS 固有の型を指定。例: <code>AWS::EC2::KeyPair::KeyName</code>。</li>
<li><strong>Default</strong>: デフォルト値を設定。ユーザが入力しなかった場合の値を。</li>
</ul>
<p><strong>擬似パラメータ (Pseudo Parameters)</strong></p>
<ul>
<li>CloudFormation が自動的に提供する 組み込みの読み取り専用パラメータ。</li>
<li>すべての CloudFormation テンプレートで デフォルトで利用可能。</li>
<li>!Ref や Fn::Sub などで参照可能。</li>
</ul>
<table>
<thead>
<tr>
<th>疑似パラメータ</th>
<th>説明</th>
<th>例</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>AWS::AccountId</code></td>
<td>AWS アカウント ID を返す</td>
<td><code>123456789012</code></td>
</tr>
<tr>
<td><code>AWS::NotificationARNs</code></td>
<td>通知先 ARN のリスト</td>
<td>[<code>arn:aws:sns:us-east-1:123456789012:mytopic</code>]</td>
</tr>
<tr>
<td><code>AWS::NoValue</code></td>
<td>値なしを返し、プロパティを削除</td>
<td>なし</td>
</tr>
<tr>
<td><code>AWS::Region</code></td>
<td>デプロイ先リージョン</td>
<td><code>ap-northeast-1</code></td>
</tr>
<tr>
<td><code>AWS::StackId</code></td>
<td>スタックの ARN</td>
<td><code>arn:aws:cloudformation:ap-northeast-1:...:stack/MyStack/...</code></td>
</tr>
<tr>
<td><code>AWS::StackName</code></td>
<td>スタック名</td>
<td><code>MyStack</code></td>
</tr>
</tbody>
</table>
<p><strong>SSM Parameters Store 参照</strong></p>
<ul>
<li>Parameter Type の <code>AWS::SSM::Parameter::Value&lt;Type&gt;</code> を使用すると Value に Parameters Store のパラメータ名を指定して値を参照できる。</li>
</ul>
<pre><code>Parameters:
  InstanceType:
    Type: 'AWS::SSM::Parameter::Value&lt;String&gt;'
    Default: /EC2/InstanceType

  ImageId:
    Type: 'AWS::SSM::Parameter::Value&lt;AWS::EC2::Image::Id&gt;'
    Default: /EC2/AMI_ID
</code></pre>
<ul>
<li><img alt="" src="_attachment/image_1841.png" /></li>
</ul>
<p>NOTE: AWS 管理の AMI の Parameters Store がある (<code>/aws/service/ami-xxx/xxx</code>)</p>
<pre><code>Parameters:
  LatestLinuxAmiId:
    Type: 'AWS::SSM::Parameter::Value&lt;AWS::EC2::Image::Id&gt;'
    # obtain list with
    # aws ssm get-parameters-by-path --path /aws/service/ami-amazon-linux-latest  --query 'Parameters[].Name'
    Default: '/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2'

  # this works for Windows too
  LatestWindowsAmiId:
    Type: 'AWS::SSM::Parameter::Value&lt;AWS::EC2::Image::Id&gt;'
    # obtain list with
    # aws ssm get-parameters-by-path --path &quot;/aws/service/ami-windows-latest&quot; --region us-east-1
    Default: '/aws/service/ami-windows-latest/Windows_Server-2016-English-Core-Base'
</code></pre>
<h3 id="mappings">Mappings セクション</h3>
<ul>
<li>リージョンごとに使用する AMI ID を指定するマッピングテーブルなどを定義する。<ul>
<li>AMI はリージョンリソースなので、リージョンごとに AMI ID が異なる。</li>
</ul>
</li>
<li>Fn::FindInMap function でアクセスする。<ul>
<li><code>!FindInMap [ MapName, TopLevelKey, SeconLevelKey ]</code></li>
</ul>
</li>
<li><img alt="" src="_attachment/image_1842.png" /></li>
<li><a href="https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/mappings-section-structure.html">https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/mappings-section-structure.html</a></li>
</ul>
<h3 id="conditions">Conditions セクション</h3>
<ul>
<li>テンプレート内で宣言的に条件指定を行って Resources, Outputs の生成を制御。</li>
<li><img alt="" src="_attachment/image_1843.png" /></li>
<li>各 Resource, Output の Condition 属性で参照する。</li>
<li>EnvType == prod の場合だけ特定リソースを作成する例。</li>
</ul>
<pre><code>Conditions:
  CreateProdResources: !Equals
    - !Ref EnvType
    - prod
Resources:
  EC2Instance:
    Type: 'AWS::EC2::Instance'
    Properties:
      ImageId: ami-0ff8a91507f77f867
  MountPoint:
    Type: 'AWS::EC2::VolumeAttachment'
    Condition: CreateProdResources
    Properties:
      InstanceId: !Ref EC2Instance
      VolumeId: !Ref NewVolume
      Device: /dev/sdh
  NewVolume:
    Type: 'AWS::EC2::Volume'
    Condition: CreateProdResources
    Properties:
      Size: 100
      AvailabilityZone: !GetAtt
        - EC2Instance
        - AvailabilityZone
</code></pre>
<ul>
<li><a href="https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/mappings-section-structure.html">https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/mappings-section-structure.html</a></li>
</ul>
<h3 id="_1">組み込み関数</h3>
<ul>
<li><code>Fn::Ref</code>  - パラメータやテンプレート内の他のリソースを参照<ul>
<li>リソースの場合は物理 ID (例: インスタンス ID) を返す。</li>
</ul>
</li>
<li><code>Fn::GetAtt</code> – 他のリソースの属性値を取得</li>
<li><code>Fn::FindInMap</code> – <code>Mappings</code> セクションから値を取得</li>
<li><code>Fn::ImportValue</code> – 他スタックが <code>Outputs</code> でエクスポートした値をインポート</li>
<li><code>Fn::Join</code> – 文字列を区切り文字で結合。<ul>
<li>例: <code>!Join [":", ["a", "b", "c"]]</code> → <code>a:b:c</code>。</li>
</ul>
</li>
<li><code>Fn::Sub</code> – 変数展開を行いながら文字列を組み立てる。<ul>
<li>例: <code>!Sub "Your account-id is ${AWS::AccountId}."</code></li>
</ul>
</li>
<li><strong>条件関数</strong> – <code>Fn::And</code>, <code>Fn::Equals</code>, <code>Fn::If</code>, <code>Fn::Not</code>, <code>Fn::Or</code>。</li>
</ul>
<p>NOTE: YAML ではショートカット !Ref 等が使用できる。</p>
<h3 id="_2">リソースの生成・更新・削除を制御する属性</h3>
<p><strong>CreationPolicy 属性</strong></p>
<ul>
<li>各リソースごとに特性に合わせた<strong>生成完了条件を指定</strong>できる。</li>
<li>例) AutoScalingGroup リソースが作成された後、グループ内の2個のインスタンスからシグナルがとどくまで生成完了とならず、次に進まない。</li>
<li>cf. WaitCondition はスタック全体の終了条件を指定するリソース</li>
</ul>
<p><img alt="" src="_attachment/image_1844.png" /></p>
<p><strong>UpdatePolicy 属性</strong></p>
<ul>
<li>AWS::AutoScaling::AutoScalingGroup<ul>
<li>AutoScalingRollingUpdate</li>
<li>AutoScalingReplacingUpdate</li>
</ul>
</li>
<li>AWS::Lambda::Alias<ul>
<li>RoutingConfig で加重エイリアスの重み付け配分</li>
</ul>
</li>
<li><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-attribute-updatepolicy.html">https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-attribute-updatepolicy.html</a></li>
</ul>
<p><strong>DeletionPolicy 属性</strong>*</p>
<ul>
<li>Delete, Retain, Snapshot</li>
</ul>
<h2 id="cloudformation_1">CloudFormation スタック</h2>
<ul>
<li>プロビジョニングはスタックを作成して実施。</li>
<li>テンプレートに必要なパラメータを入力する。</li>
<li>テンプレートを変更してスタックを更新するとプロビジョニング済みリソースが変更される。</li>
<li>スタックを削除するとプロビジョニング済みリソースが削除される。</li>
</ul>
<p><img alt="" src="_attachment/image_1849.png" /></p>
<p><img alt="" src="_attachment/image_1850.png" /></p>
<p><strong>ClientRequestToken</strong></p>
<ul>
<li>CreateStack リクエストの一意の識別子。</li>
<li>マネジメントコンソールは自動でつけてくれるが、CLIやAPIで実行する場合は自分で指定する。</li>
</ul>
<p><img alt="" src="_attachment/image_1851.png" /></p>
<p><img alt="" src="_attachment/image_1852.png" /></p>
<p><strong>TimeoutInMinutes</strong></p>
<ul>
<li>スタックのステータスが CREATE_FAILED になる までに待機可能な時間。</li>
</ul>
<p><strong>DisableRollback</strong></p>
<ul>
<li>スタック作成時のロールバックを無効化。（コンソールの「Rollback on failure」設定）</li>
<li>FAILしても作成途中のリソースはそのまま残り、後からスタックごと削除できる。</li>
</ul>
<p><strong>OnFailure</strong></p>
<ul>
<li>スタック作成が失敗した場合に実行するアクションを指定。</li>
<li>指定可能な値は <code>DO_NOTHING</code>、<code>ROLLBACK</code>、<code>DELETE</code> のいずれか。<ul>
<li><code>ROLLBACK</code>：失敗時にすべてのリソースを削除し、元の状態に戻す（デフォルト）</li>
<li><code>DO_NOTHING</code>：失敗した状態のままリソースを残す</li>
<li><code>DELETE</code>：スタック全体を削除</li>
</ul>
</li>
<li>スタック<strong>更新</strong>が失敗した場合は、自動的に以前の成功状態にロールバックされる。失敗の詳細はイベントログで確認できる。</li>
<li><code>DELETE</code> はスタック情報そのものが削除されるため、スタックのログも確認できなくなる。<ul>
<li>DELETE のユースケースはテスト自動化などでリソースを残して環境を汚したくない場合。</li>
</ul>
</li>
<li><code>OnFailure</code> と <code>DisableRollback</code> は同時に有効化できない。<ul>
<li><code>DisableRollback</code> はロールバック機能そのものを無効にし、<code>OnFailure</code> はロールバック機能の動作タイプを指定する。</li>
<li><code>DisableRollback</code> が <code>false</code> の場合、<code>OnFailure</code> の指定に従ってスタックがロールバックされる。</li>
</ul>
</li>
</ul>
<p>リソースのインポート</p>
<ul>
<li>作成済みリソースと同じ内容のリソースをテンプレートに記載してスタック作成時にリソースの識別子を指定して追加する。</li>
<li>インポートするリソース はテンプレートに DeletionPolicy 属性が必要。</li>
<li><a href="https://dev.classmethod.jp/articles/cloudformation-import-existing-resources/">https://dev.classmethod.jp/articles/cloudformation-import-existing-resources/</a></li>
</ul>
<p>AWS Pricing Calculator</p>
<ul>
<li>コンソールでのスタック作成時にコスト見積りを確認できる。</li>
<li><img alt="" src="_attachment/image_1855.png" /></li>
<li><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-cfn-paying.html">https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-cfn-paying.html</a></li>
</ul>
<p>CAPABILITY_IAM / CAPABILITY_NAMED_IAM</p>
<ul>
<li>IAM リソースを作成するテンプレートでは、create-stack/update-stack の実行に CAPABILITY_IAM または CAPABILITY_NAMED_IAM の capability の指定が必要になる。</li>
<li><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-iam-template.html#using-iam-capabilities">https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-iam-template.html#using-iam-capabilities</a></li>
</ul>
<p>作成されたリソースには aws:cloudformation::stack-name などのタグが付く</p>
<p><img alt="" src="_attachment/image_1856.png" /></p>
<p><img alt="" src="_attachment/image_1857.png" /></p>
<p>スタックのネストまたはクロススタックリファレンスで複数スタックを関係させることで多層アーキテクチャを実現する。</p>
<h3 id="outputs">Outputs セクション</h3>
<p>スタック内の値をコンソールや CLI にアウトプットする。</p>
<ul>
<li>ネストしたスタックの Outputs は 親スタックから Stack リソースの属性として参照できる。<ul>
<li>!GetAtt <em>StackName</em>.Output.<em>Name</em> で</li>
</ul>
</li>
<li>Export フィールドで Export 名を定義してエクスポートできる<ul>
<li>Fn::ImportValue で親スタック以外からも名前で参照できる。</li>
<li>Export 名の名前空間は同一アカウントのリージョン内。</li>
</ul>
</li>
</ul>
<p><img alt="" src="_attachment/image_1858.png" /></p>
<h2 id="_3">スタックのネスト</h2>
<ul>
<li><strong>AWS::CloudFormation::Stack リソース</strong>で別のテンプレートをネストする。</li>
<li>スタック更新時は親スタック (root stack) を更新する。</li>
<li>ネットワーク層とアプリ層のテンプレートをネストする例:<ul>
<li><strong>DependsOn で作成順序をコントロール</strong>している。そうしないと並列で作成されてしまう。</li>
<li>ネットワークスタックの Outputs の値を親のテンプレートから別のサブスタックであるアプリケーションスタックに Parameters で渡している。</li>
</ul>
</li>
</ul>
<p><img alt="" src="_attachment/image_1859.png" /></p>
<p><img alt="" src="_attachment/image_1860.png" /></p>
<h2 id="exportimportvalue">クロススタックリファレンス (Export/ImportValue)</h2>
<p>ネストと異なり同時にスタックを作らない場合のスタックの関連付け。</p>
<p>下記の例はネットワークスタックが作ったサブネット ID をアプリケーションスタックで参照している。</p>
<p>Export 側</p>
<ul>
<li>Outputs セクションで Export フィールドを追加し、Name 属性によりエクスポートする変数名を指定する。</li>
<li>!Sub 関数は変数値の埋め込み。"MyNetworkStack-SubnetID" のように展開される。</li>
</ul>
<pre><code>Outputs:
  Subnet:
    Description: The subnet ID to use for demo servers
    Value: !Ref Subnet1
    Export:
      Name: !Sub '${AWS::StackName}-SubnetID'
</code></pre>
<p>Import 側</p>
<ul>
<li>Fn::ImportValue 関数で参照する。</li>
</ul>
<pre><code>Parameters:
  AmazonLinuxAMIID:
    Type: AWS::SSM::Parameter::Value&lt;AWS::EC2::Image::Id&gt;
    Default: /aws/service/ami-amazon-linux-latest/amzn-ami-hvm-x86_64-gp2
  NetworkStackName:
    Type: String
    Default: MyNetworkStack

Resources:
  EC2Instance:
    Type: &quot;AWS::EC2::Instance&quot;
    Properties:
      InstanceType: t2.micro
      ImageId: !Ref AmazonLinuxAMIID
      NetworkInterfaces:
        - SubnetId:
            Fn::ImportValue:
              !Sub ${NetworkStackName}-SubnetID
          DeviceIndex: 0
</code></pre>
<p>他のスタックに<strong>リソースを参照されたスタックは削除できない</strong>。</p>
<h2 id="_4">スタックの更新</h2>
<p>テンプレートを編集して読み直すことでリソースが更新される。</p>
<h3 id="_5">変更セット</h3>
<ul>
<li>スタックを更新するには先に変更セットを作成する。(<code>create-change-set</code>)</li>
<li>変更セットの確認後に変更セットを実行する。(<code>execute-change-set</code>)</li>
</ul>
<p><img alt="" src="_attachment/image_1861.png" /></p>
<p>変更セットの作成</p>
<pre><code>aws cloudformation create-change-set \
    --stack-name AWSStudent-Lab1 \
    --change-set-name Lab1ChangeSet \
    --parameters \
        ParameterKey=InstanceType,ParameterValue=t2.micro ParameterKey=KeyName,\
        ParameterValue=$keyPair \
    --template-body file://simple-infrastructure-CS.yaml
</code></pre>
<p>変更セットの実行</p>
<pre><code>aws cloudformation execute-change-set --stack-name AWSStudent-Lab1 --change-set-name Lab1ChangeSet
</code></pre>
<p>不要になった変更セットの削除</p>
<pre><code>aws cloudformation delete-change-set --change-set-name Lab1ChangeSet --stack-name AWSStudent-Lab1
</code></pre>
<h3 id="_6">リソース更新の種類</h3>
<ul>
<li>変更セットであらかじめ確認できる。</li>
</ul>
<p><img alt="" src="_attachment/image_1862.png" /></p>
<p>Ref. UPDATE_ROLLBACK_FAILED</p>
<ul>
<li>スタック更新エラー後のロールバックが失敗した場合に出るエラー</li>
<li><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/troubleshooting.html#troubleshooting-errors-update-rollback-failed">https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/troubleshooting.html#troubleshooting-errors-update-rollback-failed</a></li>
</ul>
<h2 id="cloudformation_2">CloudFormation ヘルパースクリプト</h2>
<p>EC2 インスタンスなどにインストールして使う Python ヘルパースクリプト。
テンプレートに指定されるリソースメタデータを取得して動作する。</p>
<h3 id="metadata">MetaData 属性 (リソースメタデータ)</h3>
<ul>
<li>各リソースの MetaData 属性に指定できる任意の Key-value オブジェクト。</li>
</ul>
<pre><code>AWSTemplateFormatVersion: '2010-09-09'
Resources:
  MyS3Bucket:
    Type: AWS::S3::Bucket
    Metadata:
      Object1: Location1
      Object2: Location2
</code></pre>
<h3 id="userdata-ec2">UserData 属性 (EC2)</h3>
<ul>
<li>Fn::Base64 でテンプレート内に記載したスクリプトを UserData に渡すことができる。</li>
<li><img alt="" src="_attachment/image_1863.png" /></li>
<li>(参考) UserData 実行のアウトプットは /var/log/cloud-init-output.log に書き込まれる。<ul>
<li>cloud-init は UserData を実行する機能。</li>
</ul>
</li>
</ul>
<h3 id="cfn-init">cfn-init</h3>
<ul>
<li>パッケージのインストール、 ファイル作成、サービス開始などの初期化処理に使用するヘルパースクリプト。</li>
<li>MetaData 属性の AWS::CloudFormation::Init に記述された処理を実行する。</li>
<li>通常はインスタンスの UserData スクリプトの一部として実行される。</li>
<li>ログ出力: /var/log/cfn-init.log</li>
</ul>
<p>例1:</p>
<ul>
<li>UserData で aws-cfn-bootstrap をインストールし、cfn-init を実行。</li>
<li>cfn-init の実行内容は AWS::EC2::Instance リソースの Metadata 属性に AWS::CloudFormation::Initで記述される。</li>
</ul>
<pre><code>Resources:
  MyInstance:
    Type: AWS::EC2::Instance
    Properties:
      AvailabilityZone: us-east-1a
      ImageId: ami-009d6802948d06e52
      InstanceType: t2.micro
      KeyName: !Ref SSHKey
      SecurityGroups:
        - !Ref SSHSecurityGroup
      # we install our web server with user data
      UserData:
        Fn::Base64:
          !Sub |
            #!/bin/bash -xe
            # Get the latest CloudFormation package
            yum update -y aws-cfn-bootstrap
            # Start cfn-init
            /opt/aws/bin/cfn-init -s ${AWS::StackId} -r MyInstance --region ${AWS::Region} || error_exit 'Failed to run cfn-init'
    Metadata:
      Comment: Install a simple Apache HTTP page
      AWS::CloudFormation::Init:
        config:
          packages:
            yum:
              httpd: []
          files:
            &quot;/var/www/html/index.html&quot;:
              content: |
                &lt;h1&gt;Hello World from EC2 instance!&lt;/h1&gt;
                &lt;p&gt;This was created using cfn-init&lt;/p&gt;
              mode: '000644'
          commands:
            hello:
              command: &quot;echo 'hello world'&quot;
          services:
            sysvinit:
              httpd:
                enabled: 'true'
                ensureRunning: 'true'
</code></pre>
<h3 id="cfn-signal">cfn-signal</h3>
<ul>
<li>
<p>CreationPolicy 属性と WaitCondition で使用されるシグナルを送信するために使用するヘルパースクリプト
<img alt="" src="_attachment/image_1864.png" /></p>
</li>
<li>
<p>WaitCondition はテンプレートのリソースの1つとして作られ、このリソースが生成されるまでスタック生成が終了されないようにできる。</p>
</li>
</ul>
<p>例1: WaitCondition を使用した例</p>
<ul>
<li>cfn-signal -e $? で直前のコマンドの exit code を渡している。</li>
</ul>
<pre><code>Resources:
  MyInstance:
    Type: AWS::EC2::Instance
    Properties:
      AvailabilityZone: us-east-1a
      ImageId: ami-009d6802948d06e52
      InstanceType: t2.micro
      KeyName: !Ref SSHKey
      SecurityGroups:
        - !Ref SSHSecurityGroup
      # we install our web server with user data
      UserData:
        Fn::Base64:
          !Sub |
            #!/bin/bash -xe
            # Get the latest CloudFormation package
            yum update -y aws-cfn-bootstrap
            # Start cfn-init
            /opt/aws/bin/cfn-init -s ${AWS::StackId} -r MyInstance --region ${AWS::Region}
            # Start cfn-signal to the wait condition
            /opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackId} --resource SampleWaitCondition --region ${AWS::Region}
    Metadata:
      Comment: Install a simple Apache HTTP page
      AWS::CloudFormation::Init:
        config:
          packages:
            yum:
              httpd: []
          files:
            &quot;/var/www/html/index.html&quot;:
              content: |
                &lt;h1&gt;Hello World from EC2 instance!&lt;/h1&gt;
                &lt;p&gt;This was created using cfn-init&lt;/p&gt;
              mode: '000644'
          commands:
            hello:
              command: &quot;echo 'hello world'&quot;
          services:
            sysvinit:
              httpd:
                enabled: 'true'
                ensureRunning: 'true'

  SampleWaitCondition:
    CreationPolicy:
      ResourceSignal:
        Timeout: PT2M
        Count: 1
    Type: AWS::CloudFormation::WaitCondition
</code></pre>
<p>例2: インスタンスに CreationPolicy を使用した例</p>
<pre><code>  &quot;Resources&quot;: {
    &quot;WebServerInstance&quot;: {
      &quot;Type&quot;: &quot;AWS::EC2::Instance&quot;,
      &quot;Metadata&quot;: {
        &quot;AWS::CloudFormation::Init&quot;: {
          &quot;configSets&quot;: {
            &quot;Install&quot;: [
              &quot;Install&quot;
            ]
          },
          &quot;Install&quot;: {
            &quot;packages&quot;: {
              &quot;yum&quot;: {
                &quot;httpd&quot;: [],
                &quot;php&quot;: []
              }
            },
            &quot;files&quot;: {
              &quot;/var/www/html/index.php&quot;: {
                &quot;content&quot;: {
                  &quot;Fn::Join&quot;: [
                    &quot;&quot;,
                    [
                      &quot;&lt;html&gt;\n&quot;,
                        ...省略...
                      &quot;&lt;/html&gt;\n&quot;
                    ]
                  ]
                },
                &quot;mode&quot;: &quot;000600&quot;,
                &quot;owner&quot;: &quot;apache&quot;,
                &quot;group&quot;: &quot;apache&quot;
              }
            },
            &quot;services&quot;: {
              &quot;sysvinit&quot;: {
                &quot;httpd&quot;: {
                  &quot;enabled&quot;: &quot;true&quot;,
                  &quot;ensureRunning&quot;: &quot;true&quot;
                }
              }
            }
          }
        }
      },
      &quot;Properties&quot;: {
        &quot;ImageId&quot;: &quot;ami-0c2b8ca1dad447f8a&quot;,
        &quot;InstanceType&quot;: &quot;t3.small&quot;,
        &quot;SecurityGroups&quot;: [
          {
            &quot;Ref&quot;: &quot;WebServerSecurityGroup&quot;
          }
        ],
        &quot;KeyName&quot;: {
          &quot;Ref&quot;: &quot;KeyName&quot;
        },
        &quot;UserData&quot;: {
          &quot;Fn::Base64&quot;: {
            &quot;Fn::Join&quot;: [
              &quot;&quot;,
              [
                &quot;#!/bin/bash -xe\n&quot;,
                &quot;yum install -y aws-cfn-bootstrap\n&quot;,
                &quot;# Install the files and packages from the metadata\n&quot;,
                &quot;/opt/aws/bin/cfn-init -v &quot;,
                &quot;        --stack &quot;,
                {
                  &quot;Ref&quot;: &quot;AWS::StackName&quot;
                },
                &quot;        --resource WebServerInstance &quot;,
                &quot;        --configsets Install &quot;,
                &quot;        --region &quot;,
                {
                  &quot;Ref&quot;: &quot;AWS::Region&quot;
                },
                &quot;\n&quot;,
                &quot;# Signal the status from cfn-init\n&quot;,
                &quot;/opt/aws/bin/cfn-signal -e $? &quot;,
                &quot;        --stack &quot;,
                {
                  &quot;Ref&quot;: &quot;AWS::StackName&quot;
                },
                &quot;        --resource WebServerInstance &quot;,
                &quot;        --region &quot;,
                {
                  &quot;Ref&quot;: &quot;AWS::Region&quot;
                },
                &quot;\n&quot;
              ]
            ]
          }
        }
      },
      &quot;CreationPolicy&quot;: {
        &quot;ResourceSignal&quot;: {
          &quot;Timeout&quot;: &quot;PT5M&quot;
        }
      }
    },
</code></pre>
<ul>
<li>Ref. <a href="https://www.yamamanx.com/cfn-init-ec2-php-web/">https://www.yamamanx.com/cfn-init-ec2-php-web/</a></li>
</ul>
<p>テストで問われる cfn-signal / WaitCondition のトラブルシューティング</p>
<p><img alt="" src="_attachment/image_1865.png" /></p>
<ul>
<li>プライベートサブネットのインスタンスからシグナルを送るために CloudFormation サービスに NAT 等でアクセスできるようにする必要がある。</li>
</ul>
<h3 id="cfn-hup">cfn-hup</h3>
<ul>
<li>リソースメタデータ (Metadata 属性) の変更時にカスタムフックを実行して起動中インスタンス内で更新処理を行いたい場合に使う。<ul>
<li>テンプレートの Metadata を変更してスタック更新してもデフォルトではリソースには何の変化も起こらない。</li>
<li>変更を反映させたい場合、cfn-hup を設定するか cfn-init を手動で再実行する必要がある。</li>
</ul>
</li>
<li>スタックのメタデータ変更をポーリング監視する常駐デーモン。通常は UserData から起動する。</li>
</ul>
<p>cfn-hup.conf : 監視対象のスタックとポーリングインターバルの指定</p>
<pre><code># The cfn-hup.conf file stores the name of the stack and the AWS credentials that the cfn-hup daemon targets.
&quot;/etc/cfn/cfn-hup.conf&quot;:
  content: !Sub |
    [main]
    stack=${AWS::StackId}
    region=${AWS::Region}
    # The interval used to check for changes to the resource metadata in minutes. Default is 15
    interval=2
  mode: &quot;000400&quot;
  owner: &quot;root&quot;
  group: &quot;root&quot;
</code></pre>
<p>/etc/cfn/hooks.conf: メタデータ更新時のアクションの指定</p>
<pre><code># The user actions that the cfn-hup daemon calls periodically are defined in the hooks.conf configuration file.
# To support composition of several applications deploying change notification hooks, cfn-hup supports a directory named hooks.d that is located in the hooks configuration directory. You can place one or more additional hooks configuration files in the hooks.d directory. The additional hooks files must use the same layout as the hooks.conf file.
&quot;/etc/cfn/hooks.d/cfn-auto-reloader.conf&quot;:
  content: !Sub |
    [cfn-auto-reloader-hook]
    triggers=post.update
    path=Resources.WebServerHost.Metadata.AWS::CloudFormation::Init
    action=/opt/aws/bin/cfn-init -v --stack ${AWS::StackName} --resource WebServerHost --region ${AWS::Region}
  mode: &quot;000400&quot;
  owner: &quot;root&quot;
  group: &quot;root&quot;
</code></pre>
<ul>
<li><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/cfn-hup.html">https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/cfn-hup.html</a></li>
</ul>
<p>テンプレートでメタデータを変更してスタック更新してもデフォルトでは何も起こらない。
cfn-hup でメタデータ変更をモニタリングしている場合か、cfn-init を改めて明示的にを実行した場合のみアクションが行われる。</p>
<h3 id="cfn-get-metadata">cfn-get-metadata</h3>
<ul>
<li>リソースメタデータを取得して独自処理をする場合に使用する。</li>
<li>MetaData の内容が JSON で取得される。</li>
</ul>
<pre><code># /opt/aws/bin/cfn-get-metadata --stack CfnHupDemo --resource WebServerHost --region eu-west-1
</code></pre>
<h2 id="_7">リソースの保護</h2>
<p><img alt="" src="_attachment/image_1867.png" /></p>
<h3 id="deletionpolicy">DeletionPolicy 属性</h3>
<ul>
<li>スタックが削除される時にリソースを保持(Retain)またはバックアップ(Snapshot)できる。</li>
<li>対象リソースに DeletionPolicy 属性を指定する。</li>
</ul>
<p><img alt="" src="_attachment/image_1868.png" /></p>
<ul>
<li>Delete (default)<ul>
<li><img alt="" src="_attachment/image_1869.png" /></li>
</ul>
</li>
<li>Snapshot をサポートするリソース<ul>
<li>AWS::EC2::Volume</li>
<li>AWS::ElastiCache::CacheCluster</li>
<li>AWS::ElastiCache::ReplicationGroup</li>
<li>AWS::RDS::DBInstance</li>
<li>AWS::RDS::DBCluster</li>
<li>AWS::Redshift::Cluster</li>
</ul>
</li>
<li><img alt="" src="_attachment/image_1870.png" /></li>
</ul>
<h3 id="terminationprotection">TerminationProtection: スタックの削除保護</h3>
<ul>
<li>スタックの削除が実行できなくなる。スタック作成時と作成後にも設定できる。</li>
<li>削除保護を変更すると、ネストされたスタックにも反映される。</li>
<li><a href="https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/using-cfn-protect-stacks.html">https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/using-cfn-protect-stacks.html</a></li>
</ul>
<h3 id="_8">スタックポリシー</h3>
<ul>
<li>スタックにつけられるリソースベースポリシー。</li>
<li>重要なスタックリソースを変更する意図しないスタック更新を拒否できる。</li>
<li>まず全て Allow して、保護したいものを Deny で指定する。</li>
</ul>
<pre><code>{
    &quot;Statement&quot;: [
        {
            &quot;Effect&quot;: &quot;Allow&quot;,
            &quot;Action&quot;: &quot;Update:*&quot;,
            &quot;Principal&quot;: &quot;*&quot;,
            &quot;Resource&quot;: &quot;*&quot;
        },
        {
            &quot;Effect&quot;: &quot;Deny&quot;,
            &quot;Action&quot;: &quot;Update:*&quot;,
            &quot;Principal&quot;: &quot;*&quot;,
            &quot;Resource&quot;: &quot;LogicalResourceId/CriticalSecurityGroup&quot;
        },
        {
            &quot;Effect&quot; : &quot;Deny&quot;,
            &quot;Action&quot; : &quot;Update:*&quot;,
            &quot;Principal&quot;: &quot;*&quot;,
            &quot;Resource&quot; : &quot;*&quot;,
            &quot;Condition&quot; : {
              &quot;StringEquals&quot; : {
                &quot;ResourceType&quot; : [&quot;AWS::RDS::DBInstance&quot;]
              }
            }
        }
    ]
}
</code></pre>
<ul>
<li>Ref. <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/protect-stack-resources.html">https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/protect-stack-resources.html</a></li>
</ul>
<h2 id="_9">ドリフト検出</h2>
<p>CloudFormation 外部でスタックのリソースに直接変更が行われたか検出できる。</p>
<p>AWS コンソールでスタックアクションからドリフト検出を実施し、ドリフト詳細の表示を行う。</p>
<p>スタック全体のステータス:</p>
<ul>
<li>NOT_CHECKED</li>
<li>IN_SYNC</li>
<li>DRIFTED ... リソースに MODIFIED/DELETED が起きている</li>
</ul>
<p>リソースのステータス:</p>
<ul>
<li>NOT_CHECKED</li>
<li>IN_SYNC</li>
<li>DELETED</li>
<li>MODIFIED ... CloudFormation 管理外の変更によりリソースの設定が変わってしまった状態</li>
</ul>
<p>ネストされたスタックのドリフトは検出しない。ネストされたスタックに対して直接ドリフト検出の実行が必要。</p>
<p><img alt="" src="_attachment/image_1871.png" /></p>
<ul>
<li>動的リファレンス<ul>
<li>SSM Parameter Store や Secrets Manager 等で管理されている外部値を参照する。</li>
<li>テンプレートに機密情報を埋め込まずに済む。</li>
</ul>
</li>
</ul>
<h2 id="_10">カスタムリソース</h2>
<ul>
<li>外部リソースをカスタムリソースプロバイダー (Lambda 等) で作成・更新・削除する。</li>
<li>AWS::CloudFormation::CustomResource</li>
<li>ユースケース:<ul>
<li>CloudFormation が直接サポートしていない AWS サービスや API を利用したい場合。</li>
<li>オンプレミスのリソースや外部システムの設定を行いたい場合。</li>
<li>S3 バケットの中身を削除するなど、標準では提供されない操作を行う場合。<ul>
<li>空でない S3 バケットではスタック削除が FAIL するため、Lambda カスタムリソースで削除するのは頻出のユースケース。(DeletaionPolicy が Delete でも FAIL する)</li>
</ul>
</li>
<li>特定のリージョンやアカウントで最新の AMI ID や情報を取得する場合。<ul>
<li>リージョン毎に異なる AMI ID を Lambda カスタムリソースで取得して、カスタムリソースの Attribute として AMI ID を返すようなユースケース。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img alt="" src="_attachment/image_1873.png" /></p>
<ul>
<li>Outputs で Export された Lambda を ImportValue してカスタムリソースとして作成している例</li>
</ul>
<pre><code>Resources:
  myBucketResource:
    Type: AWS::S3::Bucket

  LambdaUsedToCleanUp:
    Type: Custom::cleanupbucket
    Properties:
      ServiceToken: !ImportValue EmptyS3BucketLambda
      BucketName: !Ref myBucketResource
</code></pre>
<p>仕組み
- Create/Update/Delete といったリクエストを  SNS メッセージでカスタムリソースプロバイダ に送信する。</p>
<pre><code>{
  &quot;RequestType&quot;: &quot;Create&quot;,
  &quot;ResponseURL&quot;: &quot;https://cloudformation-custom-resource-response...&quot;,
  &quot;StackId&quot;: &quot;arn:aws:cloudformation:ap-northeast-1:123456789012:stack/MyStack/abcd&quot;,
  &quot;RequestId&quot;: &quot;unique-id&quot;,
  &quot;LogicalResourceId&quot;: &quot;MyCustomResource&quot;,
  &quot;ResourceType&quot;: &quot;Custom::AMIInfo&quot;,
  &quot;ResourceProperties&quot;: {
    &quot;ServiceToken&quot;: &quot;arn:aws:lambda:ap-northeast-1:...:function:MyFunction&quot;,
    &quot;Region&quot;: &quot;ap-northeast-1&quot;
  }
}
</code></pre>
<ul>
<li>リクエストには以下のような値が含まれる:<ul>
<li>プロパティ属性で渡した値 (ResourceProperties)</li>
<li>応答用の S3 署名付き URL (ResponseURL)</li>
</ul>
</li>
<li>カスタムリソースプロバイダがメッセージを処理し、Success/Fail の結果が S3 署名付き URL 経由で CloudFormation に返される。</li>
<li>Lambda を使用する場合は直接 Lambda の ARN を指定でき、SNS トピックを作成する必要がない。</li>
</ul>
<h2 id="cloudformation_3">CloudFormation スタックセット</h2>
<ul>
<li>マルチアカウント/マルチリージョンへのデプロイを単一のテンプレートで管理し、1度のオペレーションでスタックを作成、更新、削除できる。</li>
<li>全アカウントに AWS Config を展開したり、共通の IAM ロールを配布するなどの用途。</li>
<li>スタック更新を実行すると、すべてのスタックインスタンスが同期して更新される。</li>
<li>同時実行設定や失敗許容数を指定し、大規模な展開の際の制御ができる。</li>
</ul>
<p><img alt="" src="_attachment/image_1875.png" /></p>
<ul>
<li>ターゲットアカウントにスタックを作成する前に、 管理者アカウントとターゲットアカウントの間に信頼関係をセットアップする必要がある。</li>
<li>信頼済みアカウントはスタックインスタンスの実行のみを許可。</li>
<li>スタックセットはリージョンリソースなので、他のリージョンで表示や変更できない。</li>
</ul>
<p>StackSets のテンプレートがある</p>
<p><img alt="" src="_attachment/image_1877.png" /></p>
<p>AWS インフラの中央ロギング</p>
<ul>
<li>CloudFormation テンプレートにより複数アカウントやリージョンからのログファイルを Elasticsearch Service にアップロードするのに必要なコンポーネントの起動・設定が自動的に行われ、ダッシュボードでの分析と可視化を実行できます。</li>
<li>複数アプリケーションを立ち上げる際にも容易に中央ロギングを AWS 上で展開することが可能になります。</li>
</ul>
<p>AWS TaskCat</p>
<ul>
<li>TaskCat は CloudFormation テンプレートのテストツールで、複数リージョンにスタックをデプロイして検証を行う。</li>
<li>必要な IAM ロールやキーを自動作成し、実行後はリソースを自動的にクリーンアップする。</li>
<li>リージョンと AZ 数を設定して、テストする CloudFormation パラメータ値を渡すことができる。</li>
<li>同時に複数リージョンでスタックが作成され、各リージョンに対して合格か失敗かの判定を示すレポートが生成される。</li>
</ul>
<p><strong>Lambda 展開の CloudFormation テンプレート例</strong></p>
<p>例: <code>ZipFile</code> でコードを直書き</p>
<pre><code>Resources:
  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - lambda.amazonaws.com
          Action:
          - sts:AssumeRole
      Path: &quot;/&quot;
      Policies:
      - PolicyName: root
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - &quot;s3:*&quot;
            Resource: &quot;*&quot;
          - Effect: Allow
            Action:
            - &quot;logs:CreateLogGroup&quot;
            - &quot;logs:CreateLogStream&quot;
            - &quot;logs:PutLogEvents&quot;
            Resource: &quot;*&quot;

  ListBucketsS3Lambda:
    Type: &quot;AWS::Lambda::Function&quot;
    Properties:
      Handler: &quot;index.handler&quot;
      Role:
        Fn::GetAtt:
          - &quot;LambdaExecutionRole&quot;
          - &quot;Arn&quot;
      Runtime: &quot;python3.7&quot;
      Code:
        ZipFile: |
          import boto3

          # Create an S3 client
          s3 = boto3.client('s3')

          def handler(event, context):
            # Call S3 to list current buckets
            response = s3.list_buckets()

            # Get a list of all bucket names from the response
            buckets = [bucket['Name'] for bucket in response['Buckets']]

            # Print out the bucket list
            print(&quot;Bucket List: %s&quot; % buckets)

            return buckets
</code></pre>
<p>例: S3 バケットから Lamda コードをアップロードする場合</p>
<ul>
<li>コードを更新する場合は <code>S3ObjectVersionParam</code> パラメタの値を更新する。</li>
</ul>
<pre><code>  ListBucketsS3Lambda:
    Type: &quot;AWS::Lambda::Function&quot;
    Properties:
      Handler: &quot;index.handler&quot;
      Role:
        Fn::GetAtt:
          - &quot;LambdaExecutionRole&quot;
          - &quot;Arn&quot;
      Runtime: &quot;python3.7&quot;
      Code:
        S3Bucket:
          Ref: S3BucketParam
        S3Key:
          Ref: S3KeyParam
        S3ObjectVersion:
          Ref: S3ObjectVersionParam
</code></pre>
<hr />
<h1 id="aws-cdk-cloud-development-kit">AWS CDK (Cloud Development Kit)</h1>
<ul>
<li>インフラストラクチャをプログラミング言語で記述。</li>
<li>サポート言語: TypeScript, JavaScript, Python, Java, C#/.Net</li>
<li>ループや条件分岐などのロジックを使って高レベル抽象化が可能。</li>
<li>コンストラクト (ライブラリ) を再利用し、ベストプラクティスを簡単に取り込める。</li>
</ul>
<p>cf. AWS SAM (Serverless Application Model)</p>
<ul>
<li>SAM は CloudFormation のトランスフォーム (マクロ) であり、CDK は CloudFormation テンプレートをコード生成する SDK</li>
</ul>
<p><strong>CDK アプリケーションの構成</strong></p>
<ul>
<li><strong>App</strong> – CDK アプリ全体のエントリポイント。1 つ以上のスタックを含む。</li>
<li><strong>Stack</strong> – CloudFormation テンプレートに相当する単位。1 つのスタックは複数のリソースで構成される。</li>
<li><strong>Construct</strong> – 再利用可能なリソースの集まりを表すクラス。<ul>
<li>Construct は「クラウドコンポーネント」のことを表し、コンポーネントの作成に CloudFormation で必要されるすべての要素をカプセル化。</li>
<li>Construct は S3 バケットなど1 つのリソースを表すこともあれば、複数の AWS CDK リソースで構成される高レベルのコンポーネントを表すこともできる。</li>
<li>低レベル (L1) から高レベル (L3) まであり、高レベルコンストラクトはベストプラクティスが組み込まれている。</li>
</ul>
</li>
<li>CDK はコードを CloudFormation テンプレートに変換し、デプロイ時には通常の CloudFormation と同じ動作をする。</li>
</ul>
<p>コード例</p>
<p><img alt="" src="_attachment/image_1881.png" /></p>
<ul>
<li>素の CloudFormation テンプレートに比べてある程度リソースを自動で作ってくれる。</li>
<li>例えば VPC を作ると関連するリソースも自動的に作ってくれる。</li>
</ul>
<p><strong>CDK CLI</strong></p>
<ul>
<li><code>cdk list</code> – デプロイ可能なスタック一覧を表示。</li>
<li><code>cdk synth</code> – CloudFormation テンプレートを生成。</li>
<li><code>cdk bootstrap</code> – 必要なリソース (CDKToolkit スタック) をアカウントに作成。</li>
<li><code>cdk deploy</code> – スタックをデプロイ。<ul>
<li>環境 (ランタイム環境) を作成。リソースの展開には CloudFormation が使われる。</li>
</ul>
</li>
<li><code>cdk destroy</code> – スタックを削除。</li>
<li><code>cdk diff</code> – 既存スタックとの差分を表示。</li>
<li><code>cdk metadata</code> – メタデータを表示。</li>
<li><code>cdk init</code> – 新規アプリケーションのひな型を生成。</li>
<li><code>cdk context</code> – コンテキスト情報を管理。</li>
<li><code>cdk docs</code> – API リファレンスを表示。</li>
<li><code>cdk doctor</code> – 環境の問題を診断。</li>
</ul>
<hr />
<h1 id="aws-elastic-beanstalk">AWS Elastic Beanstalk</h1>
<ul>
<li>Web アプリのプロビジョニング・デプロイメント・モニタリングまで一括管理。</li>
<li>Beanstalk（びーんすとーく）は「豆の木」。</li>
<li>Apache, Nginx, IIS などの Web アプリケーションサーバーに対応。</li>
<li>プロビジョニング・負荷分散・モニタリングなどを自動設定:<ul>
<li>EC2, EBS, RDS, セキュリティグループ, IAM ロール</li>
<li>ELB, Auto Scaling</li>
<li>CloudWatch Alarms, SNS</li>
</ul>
</li>
<li>プラットフォームのアップデート。</li>
<li>デプロイしたアプリのバージョニングやロールバックも。</li>
<li>Web サーバ環境と Worker 環境 (Web server tier &amp; Worker tier)</li>
</ul>
<p><img alt="" src="_attachment/File_276.png" /></p>
<p><strong>言語とプラットフォーム</strong></p>
<table>
<thead>
<tr>
<th>言語</th>
<th>開発スタック</th>
</tr>
</thead>
<tbody>
<tr>
<td>Java</td>
<td>Apache Tomcat for JavaJava SE</td>
</tr>
<tr>
<td>PHP</td>
<td>Apache HTTP Server for PHP</td>
</tr>
<tr>
<td>Python</td>
<td>Apache HTTP Server for Python</td>
</tr>
<tr>
<td>Node.js</td>
<td>Nginx or Apache HTTP Server for Node.js</td>
</tr>
<tr>
<td>Ruby</td>
<td>Passenger or Puma for Ruby</td>
</tr>
<tr>
<td>.NET</td>
<td>Microsoft IIS 7.5, 8.0, and 8.5 for .NET</td>
</tr>
<tr>
<td>Docker</td>
<td>Docker コンテナ</td>
</tr>
<tr>
<td>Go</td>
<td>Go</td>
</tr>
<tr>
<td>- 各種言語にまじって Docker もある。</td>
<td></td>
</tr>
<tr>
<td>- 多様な役割のコンテナのデプロイとオーケストレーションには ECS/EKS を使用する。</td>
<td></td>
</tr>
</tbody>
</table>
<p><img alt="" src="_attachment/File_278.png" /></p>
<p><strong>アプリケーション</strong></p>
<ul>
<li>環境、環境設定、バージョンの入れ物</li>
<li>複数環境を起動できる。</li>
</ul>
<p><strong>環境</strong></p>
<ul>
<li>インフラ環境 (Web/Worker)</li>
<li>アプリケーションバージョン (アプリのコード) をデプロイする。</li>
</ul>
<p><img alt="" src="_attachment/image_1883.png" /></p>
<p><strong>アプリケーションバージョン</strong></p>
<ul>
<li>eb deploy するたびにアプリケーションバージョンができる</li>
</ul>
<p><img alt="" src="_attachment/image_1884.png" /></p>
<p><strong>ライフサイクル</strong></p>
<ul>
<li>過去バージョンの保持期限を個数又は日数で管理</li>
<li><img alt="" src="_attachment/image_1885.png" /></li>
</ul>
<p><strong>環境のタイプ</strong>: 単一インスタンスと負荷分散 (Single-instance / Load balanced)</p>
<ul>
<li>Load balanced にすると ELB と Auto Scaling が付き、Multi-AZ にできる。</li>
</ul>
<p><img alt="" src="_attachment/image_1886.png" /></p>
<p><strong>保存済み設定: Saved configurations</strong></p>
<p>起動中の環境設定を保存して他のリージョンやアカウントで展開できる</p>
<p><code>eb config save dev-env --cfg prod</code></p>
<ul>
<li>サービス側に Saved Configuration が保存される。</li>
<li>.elasticbeanstalk/saved_configs 配下に prod.cfg.yaml ができる。</li>
<li>ローカルで直に yaml ファイルを編集できる。</li>
<li><code>eb config put prod</code> でローカル編集した yaml ファイルをサービス側に保存する。</li>
</ul>
<p><code>eb config dev-env --cfg prod</code></p>
<ul>
<li>サービス側に保存された Saved Configuration を環境に適用。</li>
</ul>
<h2 id="ebextensions">.ebextensions による拡張</h2>
<ul>
<li>環境の設定・リソースの高度なカスタマイズが可能。</li>
<li>.ebextensions 配下のディレクトリに操作を指定したコンフィグファイルを配置する。</li>
<li>ローカルで編集して、eb deploy で環境に適用する。</li>
</ul>
<p><img alt="" src="_attachment/image_1887.png" /></p>
<p>services</p>
<ul>
<li>環境内の各種サービスのコンフィグを設定: EC2, VPC, Auto Scaling, ELB, RDS  等。</li>
<li><a href="https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/command-options-general.html">https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/command-options-general.html</a></li>
</ul>
<p>resources:</p>
<ul>
<li>CloudFromation テンプレートのリソース記述で任意のリソースを追加で作成できる。</li>
<li>ただし DB のように消えたら困るリソースは環境外に個別に作成したほうがよい。</li>
</ul>
<pre><code>Resources:
  DynamoDBTable:
    Type: AWS::DynamoDB::Table
    Properties:
      KeySchema:
        HashKeyElement:
          AttributeName: id
          AttributeType: S
      # create a table with the least available rd and wr throughput
      ProvisionedThroughput:
        ReadCapacityUnits: 1
        WriteCapacityUnits: 1

  NotificationTopic:
    Type: AWS::SNS::Topic

Outputs:
  NotificationTopicArn:
    Description: Notification topic ARN
    Value: { &quot;Ref&quot; : &quot;NotificationTopic&quot; }

option_settings:
  aws:elasticbeanstalk:application:environment:
    # these are assigned dynamically during a deployment
    NOTIFICATION_TOPIC: '`{&quot;Ref&quot; : &quot;NotificationTopic&quot;}`'
    DYNAMODB_TABLE: '`{&quot;Ref&quot; : &quot;DynamoDBTable&quot;}`'
    AWS_REGION: '`{&quot;Ref&quot; : &quot;AWS::Region&quot;}`'
</code></pre>
<p>commands:</p>
<ul>
<li>コマンド実行</li>
<li>アプリケーションバージョンの<strong>ファイルが展開される前に実行</strong>される。バックアップや旧ファイルのクリーンアップなど。</li>
</ul>
<pre><code># You can use the commands key to execute commands on the EC2 instance. The commands run before the application and web server are set up and the application version file is extracted.
commands:
  create_hello_world_file:
    command: touch hello-world.txt
    cwd: /home/ec2-user
</code></pre>
<ul>
<li><a href="https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/customize-containers-ec2.html#linux-commands">https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/customize-containers-ec2.html#linux-commands</a></li>
</ul>
<p>container_commands:</p>
<ul>
<li>アプリケーションバージョンのファイルが<strong>ステージングフォルダに展開された後に実行</strong>される</li>
<li>デプロイ前の DB マイグレーションや設定ファイルの更新などに使用する</li>
</ul>
<pre><code># You can use the container_commands key to execute commands that affect your application source code. Container commands run after the application and web server have been set up and the application version archive has been extracted, but before the application version is deployed.
container_commands:
  modify_index_html:
    command: 'echo &quot; - modified content&quot; &gt;&gt; index.html'

  database_migration:
    command: 'echo &quot;do a database migration&quot;'
    # You can use leader_only to only run the command on a single instance
    leader_only: true
</code></pre>
<ul>
<li><code>leader\_only: true</code> ... 複数あるインスタンスのうち1つだけで実行する。</li>
<li><a href="https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/customize-containers-ec2.html#linux-container-commands">https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/customize-containers-ec2.html#linux-container-commands</a></li>
</ul>
<p>Container Commands vs Commands?</p>
<ul>
<li><a href="https://stackoverflow.com/questions/35788499/what-is-difference-between-commands-and-container-commands-in-elasticbean-talk/40096352#40096352">https://stackoverflow.com/questions/35788499/what-is-difference-between-commands-and-container-commands-in-elasticbean-talk/40096352#40096352</a></li>
</ul>
<p>hooks フォルダ</p>
<ul>
<li>デプロイ後にコマンド実行するには files セクションで appdeploy フォルダにスクリプトを作成する</li>
<li>/opt/elasticbeanstalk/hooks/ 配下の以下のフォルダ<ul>
<li>preinit - アプリケーションのデプロイ前</li>
<li>appdeploy - アプリケーションのデプロイ中</li>
<li>postinit - アプリケーションのデプロイ後</li>
<li>configdeploy - ユーザによる設定変更時</li>
<li>restartappserver - ユーザによるリスタート時</li>
</ul>
</li>
<li><a href="https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/custom-platform-hooks.html">https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/custom-platform-hooks.html</a></li>
</ul>
<p>設定の優先順位</p>
<ol>
<li>環境に直接 API (CLI) で適用される設定</li>
<li>保存済み設定</li>
<li>設定ファイル (.ebextensions)</li>
<li>デフォルト値</li>
</ol>
<h2 id="_11">デプロイポリシー</h2>
<p>Ref. <a href="AWS%20-%20Deployment%20Strategy.html">AWS - Deployment Strategy</a></p>
<ul>
<li>All at once</li>
<li>Rolling</li>
<li>Rolling with additional batch<ul>
<li>追加バッチにデプロイしていくのでキャパシティが減らない</li>
</ul>
</li>
<li>Immutable<ul>
<li>別のテンポラリな ASG にインスタンスを作成して新バージョンを展開</li>
<li>一時的にインスタンスコストが二倍になるがロールバックが容易</li>
</ul>
</li>
</ul>
<h2 id="worker">Worker 環境</h2>
<ul>
<li>SQS キューのリッスンまたはスケジュールでタスクを処理する Worker アプリケーション。</li>
<li>Web サーバ環境の背後で時間のかかる処理を非同期で行うのが目的。</li>
</ul>
<p><img alt="" src="_attachment/image_1888.png" /></p>
<p><a href="https://docs.aws.amazon.com/ja_jp/elasticbeanstalk/latest/dg/using-features-managing-env-tiers.html">https://docs.aws.amazon.com/ja_jp/elasticbeanstalk/latest/dg/using-features-managing-env-tiers.html</a></p>
<p><strong>SQS キュー</strong></p>
<ul>
<li>SQS を介して Web サーバー環境と連携。</li>
<li>ワーカー環境が SQS キューを管理し、各インスタンスでキューを読み取るワーカーデーモンを自動実行</li>
<li>デーモンはキューメッセージ本文を HTTP POST で localhost:80 へ送信</li>
<li>アプリ側で POST 受信で長時間タスクを実装</li>
<li>デーモン設定のカスタマイズ（送信先パス、MIME タイプ、既存キュー接続、同時実行数、タイムアウト、再試行）</li>
</ul>
<p><strong>スケジュールタスク</strong></p>
<ul>
<li>cron スケジュールに基づいてメッセージをキューに入れるようワーカーデーモンを設定</li>
<li>各タスクごとに、別のパスに POST できる。</li>
<li>ソースコードに YAML ファイル (cron.yaml) を含めて定期的なタスクを有効にする。</li>
</ul>
<p><strong>Web Server 環境と Woker 環境の連携の図</strong></p>
<p><img alt="" src="_attachment/image_1889.png" /></p>
<h2 id="docker-in-beanstalk">Docker in Beanstalk</h2>
<p>プラットフォームに Docker を選ぶ場合 ECS を利用できる。</p>
<p><img alt="" src="_attachment/image_1890.png" /></p>
<p><img alt="" src="_attachment/image_1891.png" /></p>
<h3 id="managed-updates">Managed Updates</h3>
<ul>
<li>環境の Web サーバなどのパッチ適用の自動化</li>
<li>メンテナンスウィンドウを指定する</li>
</ul>
<p><img alt="" src="_attachment/image_1892.png" /></p>
<hr />
<h1 id="aws-opsworks">AWS OpsWorks</h1>
<p><strong>Chef/Puppet のマネージド構成管理サービス</strong></p>
<ul>
<li>サーバ構成の自動化・一貫性の維持を目的とする。</li>
<li><strong>Chef/Puppet クックブックやレシピの再利用が可能。</strong></li>
<li>AWS とオンプレミスの両方を管理できる。</li>
</ul>
<p>インフラ構築ではなく、<strong>構成の一貫性維持と設定自動化</strong> に重点
- CloudFormation や Elastic Beanstalk とは目的が異なる。</p>
<h2 id="_12">主要コンポーネント</h2>
<ul>
<li><strong>AWS OpsWorks Stacks</strong><ul>
<li>Chef ベースの構成管理。Chef サーバは作成されず、一部機能のみを AWS が管理。</li>
<li><strong>レイヤー単位で EC2 インスタンス群を管理</strong>。</li>
<li>アプリケーション、DB、ロードバランサなどの複数レイヤ構成を定義。</li>
</ul>
</li>
<li><strong>AWS OpsWorks for Chef Automate</strong><ul>
<li>Chef Automate サーバの <strong>フルマネージドサービス</strong>。</li>
<li>Chef Automate の機能（テスト、ワークフロー、可視化）を利用可能。</li>
</ul>
</li>
<li><strong>AWS OpsWorks for Puppet Enterprise</strong><ul>
<li>Puppet Enterprise の <strong>フルマネージドサービス</strong>。</li>
<li>Puppet プライマリサーバを自動的にパッチ・バックアップ・更新。</li>
</ul>
</li>
</ul>
<h2 id="opsworks">OpsWorks スタック</h2>
<p><img alt="" src="_attachment/image_1893.png" /></p>
<p><strong>スタック</strong></p>
<ul>
<li>複数レイヤにまとめられた AWS リソースのスタック</li>
</ul>
<p><strong>レイヤー (Layer)</strong></p>
<ul>
<li><strong>機能別のインスタンスグループ</strong><ul>
<li>ロードバランサー層、アプリケーションサーバ層、DB 層などのレイヤにまとめられた AWS リソース</li>
</ul>
</li>
<li><strong>インスタンスタイプ</strong><ul>
<li><code>24/7</code>: 常時稼働</li>
<li><code>Time-based</code>: スケジュールで起動・停止（例: 夜間バッチ）</li>
<li><code>Load-based</code>: CPU などの負荷指標でスケール制御</li>
</ul>
</li>
</ul>
<p><img alt="" src="_attachment/image_1894.png" /></p>
<p><strong>クックブックとレシピ</strong></p>
<ul>
<li><strong>クックブックリポジトリ</strong><ul>
<li>Git、S3、HTTP などの Chef クックブックの保存場所。</li>
</ul>
</li>
<li><strong>レシピ</strong><ul>
<li>レイヤーごとに実行される設定スクリプト。</li>
<li>OpsWorks スタックは各ライフサイクルイベントで対応するレシピを自動実行。</li>
</ul>
</li>
</ul>
<p><strong>アプリケーション</strong></p>
<ul>
<li>アプリケーションコードは Git, S3 などのリポジトリに保存。</li>
<li>インスタンスにアプリケーションをデプロイする際、<code>Deploy</code>ライフサイクルイベントがトリガーされ、レイヤーのデプロイレシピがそのインスタンスで実行される。</li>
</ul>
<h3 id="_13">ライフサイクルイベント</h3>
<p>各レイヤーでライフサイクルイベントごとに実行するレシピ (Chef cookbook) を指定できる。</p>
<ul>
<li><strong>Setup</strong><ul>
<li>インスタンス起動完了直後に実行。</li>
</ul>
</li>
<li><strong>Configure</strong><ul>
<li>スタック内のいずれかのインスタンスが<strong>オンライン/オフライン</strong>になると全インスタンスで実行。</li>
<li>構成変更やクラスタ更新（例: IPリスト更新）に利用。</li>
</ul>
</li>
<li><strong>Deploy</strong><ul>
<li><code>Deploy</code> コマンドでアプリケーションをデプロイ。</li>
</ul>
</li>
<li><strong>Undeploy</strong><ul>
<li>アプリケーション削除時に実行。</li>
</ul>
</li>
<li><strong>Shutdown</strong><ul>
<li>インスタンス終了前に実行。</li>
</ul>
</li>
</ul>
<p><strong>試験頻出例：</strong></p>
<ul>
<li>クラスタ構成ファイル（例: <code>nodes.config</code>）を常に最新化する場合
    → <code>Configure</code> イベントに Chef レシピを設定。</li>
</ul>
<p><a href="https://docs.aws.amazon.com/opsworks/latest/userguide/workingcookbook-events.html">https://docs.aws.amazon.com/opsworks/latest/userguide/workingcookbook-events.html</a></p>
<p><img alt="" src="_attachment/image_1895.png" /></p>
<p>問題例</p>
<p>You are working as a DevOps engineer for a leading telecommunications company which is planning to host a distributed system in AWS. Their system must be hosted on multiple Linux-based application servers which must use the same configuration file that tracks any changes in the cluster such as adding or removing a server. The configuration file is named as <em>tdojo-nodes.config</em> which contains the list of private IP addresses of the servers in the cluster and other metadata.</p>
<p>Which of the following is the MOST automated way to meet the above requirements?</p>
<p>解答</p>
<p>Layer the application server nodes of the cluster using AWS OpsWorks Stacks and add a Chef recipe associated with the <strong>Configure</strong> Lifecycle Event which populates the <em>tdojo-nodes.config</em> file. Set up a configuration which runs each layer's <strong>Configure</strong> recipes that updates the configuration file when a cluster change is detected.</p>
<h3 id="auto-healing">自動ヒーリング (Auto Healing)</h3>
<ul>
<li>OpsWorks Agent がインスタンスのヘルスチェック。</li>
<li>通信不能や異常時に新しいインスタンスを自動プロビジョン。</li>
<li>イベントを <strong>Amazon EventBridge</strong> で監視し、SNS 通知などに連携可能。</li>
<li><img alt="" src="_attachment/image_1896.png" /></li>
<li><a href="https://docs.aws.amazon.com/opsworks/latest/userguide/workinginstances-autohealing.html">https://docs.aws.amazon.com/opsworks/latest/userguide/workinginstances-autohealing.html</a></li>
<li>問題例: The DevOps team should receive an email whenever AWS OpsWorks restarts an instance that is considered unhealthy or unable to communicate with the service endpoint.</li>
<li><img alt="" src="_attachment/image_1897.png" /></li>
</ul>
</article>

    </main>
    <footer>
        <p>&copy; 2025 AWS DevOps Notes</p>
    </footer>
    <script src="static/script.js"></script>
</body>
</html>