<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>AWS - CloudFormation, Elastic Beanstalk, OpsWork - AWS DevOps Notes</title>
    <link rel="stylesheet" href="static/style.css">
</head>
<body>
    
    <header>
        <h1>AWS - CloudFormation, Elastic Beanstalk, OpsWork</h1>
    </header>
    
    <main>
        
<article>
    <h2 id="infrastructure-as-code">プロビジョニング・デプロイ自動化とInfrastructure as Code</h2>
<p><img alt="" src="_attachment/File_268.png" /><img alt="" src="_attachment/File_269.png" /></p>
<ul>
<li>CloudFormation は AWS リソースのプロビジョニングに特化。</li>
<li>Beanstalk, OpsWorks はインフラのプロビジョニング、アプリケーションのデプロイ、運用時のモニタリングまで全体をカバー。</li>
</ul>
<p>(参考)【AWS初心者向けWebinar】AWSのプロビジョニングからデプロイまで</p>
<p><a href="https://www.slideshare.net/AmazonWebServicesJapan/awswebinaraws-54198407">https://www.slideshare.net/AmazonWebServicesJapan/awswebinaraws-54198407</a></p>
<p><img alt="" src="_attachment/File_270.png" /></p>
<p>(参考) VMware でのプロビジョニングとデプロイ</p>
<ul>
<li>プロビジョニング<ul>
<li>準備・予測という意味</li>
<li>リソースを準備すること。主にディスクストレージエリアのサイズや方式（ShinやThick)、CPUやメモリのリソース予約を行う。</li>
<li>事前にリソース消費を予測して準備することが必要。主にストレージのプロビジョニングはデプロイにも関係してくる。</li>
</ul>
</li>
<li>デプロイ<ul>
<li>展開・生成という意味</li>
<li>プロビジョニングされたエリアにOSイメージを生成すること。テンプレート、マスターイメージよりデプロイする。</li>
<li>もともと「デプロイ」にはS/Wをインストールするという意味もあるが、VMwareではテンプレートなどからOSイメージを生成することをいう。</li>
</ul>
</li>
</ul>
<p><img alt="" src="_attachment/File_271.png" /><img alt="" src="_attachment/File_272.png" /></p>
<ul>
<li>CloudFormation は AWS インフラのプロビジョニング<ul>
<li>ソフトウェアのデプロイやアップデートなどはしない。</li>
</ul>
</li>
<li>CloudFormation + Beanstalk/OpsWork との組み合わせもできる</li>
<li>Beanstalk, OpsWork はプロビジョニング、デプロイ、モニタリングまで含む<ul>
<li>Web アプリの定番構成 → Beanstalk</li>
<li>Web アプリでない、定番構成でない、既に Chef/Puppet 使っている → OpsWork</li>
</ul>
</li>
</ul>
<hr />
<h1 id="aws-cloudformation">AWS CloudFormation</h1>
<ul>
<li>AWS サービスのプロビジョニングを実施するサービス。</li>
<li>テキストファイルによるテンプレート記述。</li>
<li>無料。</li>
</ul>
<p><img alt="" src="_attachment/File_273.png" /></p>
<h2 id="cloudformation">CloudFormation テンプレート</h2>
<ul>
<li>JSON or YAML 形式。<ul>
<li>変装をパラメータとして渡せる。</li>
<li>テンプレートは S3 にアップロードする必要がある。</li>
</ul>
</li>
<li>CloudFormation デザイナー<ul>
<li>テンプレート作成の GUI ツール。リソースをドラッグ&amp;ドロップして編集。</li>
</ul>
</li>
</ul>
<p><img alt="" src="_attachment/File_274.png" /></p>
<ul>
<li><a href="https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/working-with-templates-cfn-designer-overview.html">https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/working-with-templates-cfn-designer-overview.html</a></li>
<li>テンプレートスニペット<ul>
<li>AWS の各種リソースのテンプレート例 (JSON/YAML)</li>
<li><a href="https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/CHAP_TemplateQuickRef.html">https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/CHAP_TemplateQuickRef.html</a></li>
</ul>
</li>
</ul>
<p>テンプレートの項目</p>
<p><img alt="" src="_attachment/image_1836.png" /></p>
<h3 id="parameters">Parameters</h3>
<p><img alt="" src="_attachment/image_1837.png" /></p>
<h4 id="parameters_1">Parameters の項目</h4>
<ul>
<li><strong>Type:</strong><ul>
<li>String</li>
<li>Number</li>
<li>CommaDelimitedList</li>
<li>List\&lt;Type&gt;</li>
<li>AWS Parameter (to help catch invalid values – match against existing values in the AWS Account)</li>
</ul>
</li>
<li><strong>Description</strong></li>
<li><strong>Constraints</strong><ul>
<li>ConstraintDescription (String)<ul>
<li>Constraints がエラーになった場合にエラーメッセージとして出力する文字列。</li>
</ul>
</li>
<li>Min/MaxLength</li>
<li>Min/MaxValue</li>
<li>Defaults</li>
<li>AllowedValues (array)</li>
<li>AllowedPattern (regexp)</li>
<li>NoEcho (Boolean)<ul>
<li>パラメタ値をコンソールや CLI 出力でマスクするかを指定。</li>
</ul>
</li>
</ul>
</li>
<li><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/parameters-section-structure.html">https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/parameters-section-structure.html</a></li>
</ul>
<p><img alt="" src="_attachment/image_1839.png" /><img alt="" src="_attachment/image_1840.png" /></p>
<h3 id="fnref-function">Fn::Ref function</h3>
<ul>
<li>パラメタやテンプレート内の他のリソースを参照する。</li>
<li>YAML ではショートカット !Ref が使用できる。</li>
</ul>
<h3 id="ssm-parameters-store">SSM Parameters Store の参照</h3>
<ul>
<li>Type に AWS::SSM::Parameter::* を指定すると Value に Parameters Store のパラメータ名を指定して値を参照するようになる。</li>
</ul>
<pre><code>Parameters:
  InstanceType:
    Type: 'AWS::SSM::Parameter::Value&lt;String&gt;'
    Default: /EC2/InstanceType

  ImageId:
    Type: 'AWS::SSM::Parameter::Value&lt;AWS::EC2::Image::Id&gt;'
    Default: /EC2/AMI_ID
</code></pre>
<ul>
<li><img alt="" src="_attachment/image_1841.png" /></li>
<li>AWS management の AMI の Parameters Store がある</li>
</ul>
<pre><code>Parameters:
  LatestLinuxAmiId:
    Type: 'AWS::SSM::Parameter::Value&lt;AWS::EC2::Image::Id&gt;'
    # obtain list with
    # aws ssm get-parameters-by-path --path /aws/service/ami-amazon-linux-latest  --query 'Parameters[].Name'
    Default: '/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2'

  # this works for Windows too
  LatestWindowsAmiId:
    Type: 'AWS::SSM::Parameter::Value&lt;AWS::EC2::Image::Id&gt;'
    # obtain list with
    # aws ssm get-parameters-by-path --path &quot;/aws/service/ami-windows-latest&quot; --region us-east-1
    Default: '/aws/service/ami-windows-latest/Windows_Server-2016-English-Core-Base'
</code></pre>
<h3 id="mappings">Mappings</h3>
<ul>
<li>リージョンごとに使用する AMI ID を指定するマッピングテーブルなどを定義する。<ul>
<li>AMI はリージョンリソースなので、リージョンごとに AMI ID が異なる。</li>
</ul>
</li>
<li>Fn::FindInMap function でアクセスする。<ul>
<li><code>!FindInMap [ MapName, TopLevelKey, SeconLevelKey ]</code></li>
</ul>
</li>
<li><img alt="" src="_attachment/image_1842.png" /></li>
<li><a href="https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/mappings-section-structure.html">https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/mappings-section-structure.html</a></li>
</ul>
<h3 id="conditions">Conditions セクション</h3>
<ul>
<li>テンプレート内で宣言的に条件指定を行って Resources, Outputs の生成を制御。</li>
<li><img alt="" src="_attachment/image_1843.png" /></li>
<li>各 Resource, Output の Condition 属性で参照する。</li>
<li>EnvType == prod の場合だけ特定リソースを作成する例。</li>
</ul>
<pre><code>Conditions:
  CreateProdResources: !Equals
    - !Ref EnvType
    - prod
Resources:
  EC2Instance:
    Type: 'AWS::EC2::Instance'
    Properties:
      ImageId: ami-0ff8a91507f77f867
  MountPoint:
    Type: 'AWS::EC2::VolumeAttachment'
    Condition: CreateProdResources
    Properties:
      InstanceId: !Ref EC2Instance
      VolumeId: !Ref NewVolume
      Device: /dev/sdh
  NewVolume:
    Type: 'AWS::EC2::Volume'
    Condition: CreateProdResources
    Properties:
      Size: 100
      AvailabilityZone: !GetAtt
        - EC2Instance
        - AvailabilityZone
</code></pre>
<ul>
<li><a href="https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/mappings-section-structure.html">https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/mappings-section-structure.html</a></li>
</ul>
<h3 id="creationpolicy">CreationPolicy 属性</h3>
<ul>
<li>各リソースに指定できる属性。リソースの特性に合わせた<strong>生成完了条件を指定</strong>する。</li>
<li>例) AutoScalingGroup リソースが作成された後、グループ内の2個のインスタンスからシグナルがとどくまで生成完了とならず、次に進まない。</li>
</ul>
<p><img alt="" src="_attachment/image_1844.png" /></p>
<h3 id="updatepolicy">UpdatePolicy 属性</h3>
<ul>
<li>AWS::AutoScaling::AutoScalingGroup<ul>
<li>AutoScalingRollingUpdate</li>
<li>AutoScalingReplacingUpdate</li>
</ul>
</li>
<li>AWS::Lambda::Alias<ul>
<li>RoutingConfig で加重エイリアスの重み付け配分</li>
</ul>
</li>
<li><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-attribute-updatepolicy.html">https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-attribute-updatepolicy.html</a></li>
</ul>
<h3 id="deletionpolicy">DeletionPolicy 属性</h3>
<ul>
<li>Delete, Retain, Snapshot</li>
</ul>
<h3 id="_1">組み込み関数</h3>
<p><img alt="" src="_attachment/image_1845.png" /></p>
<h4 id="fnref">Fn::Ref</h4>
<p><img alt="" src="_attachment/image_1846.png" /></p>
<h4 id="fngetatt">Fn::GetAtt</h4>
<ul>
<li>リソースの属性を取得する。</li>
<li><img alt="" src="_attachment/image_1847.png" /></li>
</ul>
<pre><code>      Role:
        Fn::GetAtt:
          - &quot;LambdaExecutionRole&quot;
          - &quot;Arn&quot;
</code></pre>
<h4 id="fnjoin">Fn::Join</h4>
<p><img alt="" src="_attachment/image_1848.png" /></p>
<h4 id="fnsub">Fn::Sub</h4>
<ul>
<li>文字列内で参照する変数を値に置き換える(Substitute)。</li>
<li>!Sub "Your account-id is ${AWS::AccountId}."</li>
</ul>
<h2 id="cloudformation_1">CloudFormation スタック</h2>
<ul>
<li>プロビジョニングはスタックを作成して実施。</li>
<li>テンプレートに必要なパラメータを入力する。</li>
<li>テンプレートを変更してスタックを更新するとプロビジョニング済みリソースが変更される。</li>
<li>スタックを削除するとプロビジョニング済みリソースが削除される。</li>
</ul>
<p><img alt="" src="_attachment/image_1849.png" /></p>
<p><img alt="" src="_attachment/image_1850.png" /></p>
<p><strong>ClientRequestToken</strong></p>
<ul>
<li>CreateStack リクエストの一意の識別子。</li>
<li>マネジメントコンソールは自動でつけてくれるが、CLIやAPIで実行する場合は自分で指定する。</li>
</ul>
<p><img alt="" src="_attachment/image_1851.png" /><img alt="" src="_attachment/image_1852.png" /></p>
<p><strong>TimeoutInMinutes</strong></p>
<ul>
<li>スタックのステータスが CREATE_FAILED になる までに待機可能な時間。</li>
</ul>
<p><strong>DisableRollback</strong></p>
<ul>
<li>スタック作成時のロールバックを無効化。（コンソールの 「<code>Rollback on failure</code>」 設定）</li>
<li>FAIL した場合もリソースは残り、後からスタックごと削除できる。</li>
</ul>
<p><strong>OnFailure</strong></p>
<ul>
<li>スタック作成に失敗した場合に実行するアクションを指定。</li>
<li>DO_NOTHING、ROLLBACK、DELETE のいずれか。<ul>
<li><code>ROLLBACK</code>: 失敗時にすべてのリソースを削除し元の状態に戻す (デフォルト)。</li>
<li><code>DO_NOTHING</code>: 失敗した状態のままリソースを残す。</li>
<li><code>DELETE</code>: スタック全体を削除する。</li>
</ul>
</li>
<li>スタック<strong>更新</strong>に失敗した場合は、自動的に以前の成功した状態へロールバックされる。失敗の詳細はイベントログで確認できる。</li>
<li>DELETE ではスタックの情報そのものが消去されるのでスタックのログも見られない。</li>
<li>OnFailure と DisableRollback の両方は有効にできない。</li>
<li>DisableRollback が false の場合、OnFailure の指定に従ってスタックがロールバックされる。</li>
</ul>
<p>リソースのインポート</p>
<ul>
<li>作成済みリソースと同じ内容のリソースをテンプレートに記載してスタック作成時にリソースの識別子を指定して追加する。</li>
<li>インポートするリソース はテンプレートに DeletionPolicy 属性が必要。</li>
<li><a href="https://dev.classmethod.jp/articles/cloudformation-import-existing-resources/">https://dev.classmethod.jp/articles/cloudformation-import-existing-resources/</a></li>
</ul>
<p>AWS Pricing Calculator</p>
<ul>
<li>コンソールでのスタック作成時にコスト見積りを確認できる。</li>
<li><img alt="" src="_attachment/image_1855.png" /></li>
<li><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-cfn-paying.html">https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-cfn-paying.html</a></li>
</ul>
<p>CAPABILITY_IAM / CAPABILITY_NAMED_IAM</p>
<ul>
<li>IAM リソースを作成するテンプレートでは、create-stack/update-stack の実行に CAPABILITY_IAM または CAPABILITY_NAMED_IAM の capability の指定が必要になる。</li>
<li><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-iam-template.html#using-iam-capabilities">https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-iam-template.html#using-iam-capabilities</a></li>
</ul>
<p>作成されたリソースには aws:cloudformation::stack-name などのタグが付く</p>
<p><img alt="" src="_attachment/image_1856.png" /></p>
<p><img alt="" src="_attachment/image_1857.png" /></p>
<p>スタックのネストまたはクロススタックリファレンスで複数スタックを関係させることで多層アーキテクチャを実現する。</p>
<h3 id="outputs-section">Outputs section</h3>
<p>スタック内の値をコンソールや CLI にアウトプットする。</p>
<ul>
<li>ネストしたスタックの Outputs は 親スタックから Stack リソースの属性として参照できる。<ul>
<li>!GetAtt <em>StackName</em>.Output.<em>Name</em> で</li>
</ul>
</li>
<li>Export フィールドで Export 名を定義してエクスポートできる<ul>
<li>Fn::ImportValue で親スタック以外からも名前で参照できる。</li>
<li>Export 名の名前空間は同一アカウントのリージョン内。</li>
</ul>
</li>
</ul>
<p><img alt="" src="_attachment/image_1858.png" /></p>
<h2 id="_2">スタックのネスト</h2>
<ul>
<li><strong>AWS::CloudFormation::Stack リソース</strong>で別のテンプレートをネストする。</li>
<li>スタック更新時は親スタック (root stack) を更新する。</li>
<li>ネットワーク層とアプリ層のテンプレートをネストする例:<ul>
<li><strong>DependsOn で作成順序をコントロール</strong>している。そうしないと並列で作成されてしまう。</li>
<li>ネットワークスタックの Outputs の値を親のテンプレートから別のサブスタックであるアプリケーションスタックに Parameters で渡している。</li>
</ul>
</li>
</ul>
<p><img alt="" src="_attachment/image_1859.png" /><img alt="" src="_attachment/image_1860.png" /></p>
<h2 id="exportimportvalue">クロススタックリファレンス (Export/ImportValue)</h2>
<p>ネストと異なり同時にスタックを作らない場合のスタックの関連付け。</p>
<p>下記の例はネットワークスタックが作ったサブネット ID をアプリケーションスタックで参照している。</p>
<p>Export 側</p>
<ul>
<li>Outputs セクションで Export フィールドを追加し、Name 属性によりエクスポートする変数名を指定する。</li>
<li>!Sub 関数は変数値の埋め込み。"MyNetworkStack-SubnetID" のように展開される。</li>
</ul>
<pre><code>Outputs:
  Subnet:
    Description: The subnet ID to use for demo servers
    Value: !Ref Subnet1
    Export:
      Name: !Sub '${AWS::StackName}-SubnetID'
</code></pre>
<p>Import 側</p>
<ul>
<li>Fn::ImportValue 関数で参照する。</li>
</ul>
<pre><code>Parameters:
  AmazonLinuxAMIID:
    Type: AWS::SSM::Parameter::Value&lt;AWS::EC2::Image::Id&gt;
    Default: /aws/service/ami-amazon-linux-latest/amzn-ami-hvm-x86_64-gp2
  NetworkStackName:
    Type: String
    Default: MyNetworkStack

Resources:
  EC2Instance:
    Type: &quot;AWS::EC2::Instance&quot;
    Properties:
      InstanceType: t2.micro
      ImageId: !Ref AmazonLinuxAMIID
      NetworkInterfaces:
        - SubnetId:
            Fn::ImportValue:
              !Sub ${NetworkStackName}-SubnetID
          DeviceIndex: 0
</code></pre>
<p>他のスタックに<strong>リソースを参照されたスタックは削除できない</strong>。</p>
<h2 id="_3">スタックの更新</h2>
<p>テンプレートを編集して読み直すことでリソースが更新される。</p>
<h3 id="_4">変更セット</h3>
<ul>
<li>スタックを更新するには先に変更セットを作成する。(<code>create-change-set</code>)</li>
<li>変更セットの確認後に変更セットを実行する。(<code>execute-change-set</code>)</li>
</ul>
<p><img alt="" src="_attachment/image_1861.png" /></p>
<p>変更セットの作成</p>
<pre><code>aws cloudformation create-change-set \
    --stack-name AWSStudent-Lab1 \
    --change-set-name Lab1ChangeSet \
    --parameters \
        ParameterKey=InstanceType,ParameterValue=t2.micro ParameterKey=KeyName,\
        ParameterValue=$keyPair \
    --template-body file://simple-infrastructure-CS.yaml
</code></pre>
<p>変更セットの実行</p>
<pre><code>aws cloudformation execute-change-set --stack-name AWSStudent-Lab1 --change-set-name Lab1ChangeSet
</code></pre>
<p>不要になった変更セットの削除</p>
<pre><code>aws cloudformation delete-change-set --change-set-name Lab1ChangeSet --stack-name AWSStudent-Lab1
</code></pre>
<h3 id="_5">リソース更新の種類</h3>
<ul>
<li>変更セットであらかじめ確認できる。</li>
</ul>
<p><img alt="" src="_attachment/image_1862.png" /></p>
<p>Ref.</p>
<ul>
<li>UPDATE_ROLLBACK_FAILED<ul>
<li>スタック更新エラー後のロールバックが失敗した場合に出るエラー。</li>
<li><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/troubleshooting.html#troubleshooting-errors-update-rollback-failed">https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/troubleshooting.html#troubleshooting-errors-update-rollback-failed</a></li>
</ul>
</li>
</ul>
<h2 id="cloudformation_2">CloudFormation ヘルパースクリプト</h2>
<p>EC2 インスタンスなどにインストールして使う Python ヘルパースクリプト。
テンプレートに指定されるリソースメタデータを取得して動作する。</p>
<h3 id="metadata">MetaData 属性 (リソースメタデータ)</h3>
<ul>
<li>各リソースの MetaData 属性に指定できる任意の Key-value オブジェクト。</li>
</ul>
<pre><code>AWSTemplateFormatVersion: '2010-09-09'
Resources:
  MyS3Bucket:
    Type: AWS::S3::Bucket
    Metadata:
      Object1: Location1
      Object2: Location2
</code></pre>
<h3 id="userdata-ec2">UserData 属性 (EC2)</h3>
<ul>
<li>Fn::Base64 でテンプレート内に記載したスクリプトを UserData に渡すことができる。</li>
<li><img alt="" src="_attachment/image_1863.png" /></li>
<li>(参考) UserData 実行のアウトプットは /var/log/cloud-init-output.log に書き込まれる。<ul>
<li>cloud-init は UserData を実行する機能。</li>
</ul>
</li>
</ul>
<h3 id="cfn-init">cfn-init</h3>
<ul>
<li>パッケージのインストール、 ファイル作成、サービス開始などの初期化処理に使用するヘルパースクリプト。</li>
<li>MetaData 属性の AWS::CloudFormation::Init に記述された処理を実行する。</li>
<li>通常はインスタンスの UserData スクリプトの一部として実行される。</li>
<li>ログ出力: /var/log/cfn-init.log</li>
</ul>
<p>例1:</p>
<ul>
<li>UserData で aws-cfn-bootstrap をインストールし、cfn-init を実行。</li>
<li>cfn-init の実行内容は AWS::EC2::Instance リソースの Metadata 属性に AWS::CloudFormation::Initで記述される。</li>
</ul>
<pre><code>Resources:
  MyInstance:
    Type: AWS::EC2::Instance
    Properties:
      AvailabilityZone: us-east-1a
      ImageId: ami-009d6802948d06e52
      InstanceType: t2.micro
      KeyName: !Ref SSHKey
      SecurityGroups:
        - !Ref SSHSecurityGroup
      # we install our web server with user data
      UserData:
        Fn::Base64:
          !Sub |
            #!/bin/bash -xe
            # Get the latest CloudFormation package
            yum update -y aws-cfn-bootstrap
            # Start cfn-init
            /opt/aws/bin/cfn-init -s ${AWS::StackId} -r MyInstance --region ${AWS::Region} || error_exit 'Failed to run cfn-init'
    Metadata:
      Comment: Install a simple Apache HTTP page
      AWS::CloudFormation::Init:
        config:
          packages:
            yum:
              httpd: []
          files:
            &quot;/var/www/html/index.html&quot;:
              content: |
                &lt;h1&gt;Hello World from EC2 instance!&lt;/h1&gt;
                &lt;p&gt;This was created using cfn-init&lt;/p&gt;
              mode: '000644'
          commands:
            hello:
              command: &quot;echo 'hello world'&quot;
          services:
            sysvinit:
              httpd:
                enabled: 'true'
                ensureRunning: 'true'
</code></pre>
<h3 id="cfn-signal">cfn-signal</h3>
<ul>
<li>CreationPolicy 属性と WaitCondition で使用されるシグナルを送信するために使用するコマンド。</li>
</ul>
<p><img alt="" src="_attachment/image_1864.png" /></p>
<ul>
<li>WaitCondition はテンプレートのリソースの1つとして作られ、このリソースが生成されるまでスタック生成が終了されないようにできる。</li>
</ul>
<p>例1: WaitCondition を使用した例</p>
<ul>
<li>cfn-signal -e $? で直前のコマンドの exit code を渡している。</li>
</ul>
<pre><code>Resources:
  MyInstance:
    Type: AWS::EC2::Instance
    Properties:
      AvailabilityZone: us-east-1a
      ImageId: ami-009d6802948d06e52
      InstanceType: t2.micro
      KeyName: !Ref SSHKey
      SecurityGroups:
        - !Ref SSHSecurityGroup
      # we install our web server with user data
      UserData:
        Fn::Base64:
          !Sub |
            #!/bin/bash -xe
            # Get the latest CloudFormation package
            yum update -y aws-cfn-bootstrap
            # Start cfn-init
            /opt/aws/bin/cfn-init -s ${AWS::StackId} -r MyInstance --region ${AWS::Region}
            # Start cfn-signal to the wait condition
            /opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackId} --resource SampleWaitCondition --region ${AWS::Region}
    Metadata:
      Comment: Install a simple Apache HTTP page
      AWS::CloudFormation::Init:
        config:
          packages:
            yum:
              httpd: []
          files:
            &quot;/var/www/html/index.html&quot;:
              content: |
                &lt;h1&gt;Hello World from EC2 instance!&lt;/h1&gt;
                &lt;p&gt;This was created using cfn-init&lt;/p&gt;
              mode: '000644'
          commands:
            hello:
              command: &quot;echo 'hello world'&quot;
          services:
            sysvinit:
              httpd:
                enabled: 'true'
                ensureRunning: 'true'

  SampleWaitCondition:
    CreationPolicy:
      ResourceSignal:
        Timeout: PT2M
        Count: 1
    Type: AWS::CloudFormation::WaitCondition
</code></pre>
<p>例2: インスタンスに CreationPolicy を使用した例</p>
<pre><code>  &quot;Resources&quot;: {
    &quot;WebServerInstance&quot;: {
      &quot;Type&quot;: &quot;AWS::EC2::Instance&quot;,
      &quot;Metadata&quot;: {
        &quot;AWS::CloudFormation::Init&quot;: {
          &quot;configSets&quot;: {
            &quot;Install&quot;: [
              &quot;Install&quot;
            ]
          },
          &quot;Install&quot;: {
            &quot;packages&quot;: {
              &quot;yum&quot;: {
                &quot;httpd&quot;: [],
                &quot;php&quot;: []
              }
            },
            &quot;files&quot;: {
              &quot;/var/www/html/index.php&quot;: {
                &quot;content&quot;: {
                  &quot;Fn::Join&quot;: [
                    &quot;&quot;,
                    [
                      &quot;&lt;html&gt;\n&quot;,
                        ...省略...
                      &quot;&lt;/html&gt;\n&quot;
                    ]
                  ]
                },
                &quot;mode&quot;: &quot;000600&quot;,
                &quot;owner&quot;: &quot;apache&quot;,
                &quot;group&quot;: &quot;apache&quot;
              }
            },
            &quot;services&quot;: {
              &quot;sysvinit&quot;: {
                &quot;httpd&quot;: {
                  &quot;enabled&quot;: &quot;true&quot;,
                  &quot;ensureRunning&quot;: &quot;true&quot;
                }
              }
            }
          }
        }
      },
      &quot;Properties&quot;: {
        &quot;ImageId&quot;: &quot;ami-0c2b8ca1dad447f8a&quot;,
        &quot;InstanceType&quot;: &quot;t3.small&quot;,
        &quot;SecurityGroups&quot;: [
          {
            &quot;Ref&quot;: &quot;WebServerSecurityGroup&quot;
          }
        ],
        &quot;KeyName&quot;: {
          &quot;Ref&quot;: &quot;KeyName&quot;
        },
        &quot;UserData&quot;: {
          &quot;Fn::Base64&quot;: {
            &quot;Fn::Join&quot;: [
              &quot;&quot;,
              [
                &quot;#!/bin/bash -xe\n&quot;,
                &quot;yum install -y aws-cfn-bootstrap\n&quot;,
                &quot;# Install the files and packages from the metadata\n&quot;,
                &quot;/opt/aws/bin/cfn-init -v &quot;,
                &quot;        --stack &quot;,
                {
                  &quot;Ref&quot;: &quot;AWS::StackName&quot;
                },
                &quot;        --resource WebServerInstance &quot;,
                &quot;        --configsets Install &quot;,
                &quot;        --region &quot;,
                {
                  &quot;Ref&quot;: &quot;AWS::Region&quot;
                },
                &quot;\n&quot;,
                &quot;# Signal the status from cfn-init\n&quot;,
                &quot;/opt/aws/bin/cfn-signal -e $? &quot;,
                &quot;        --stack &quot;,
                {
                  &quot;Ref&quot;: &quot;AWS::StackName&quot;
                },
                &quot;        --resource WebServerInstance &quot;,
                &quot;        --region &quot;,
                {
                  &quot;Ref&quot;: &quot;AWS::Region&quot;
                },
                &quot;\n&quot;
              ]
            ]
          }
        }
      },
      &quot;CreationPolicy&quot;: {
        &quot;ResourceSignal&quot;: {
          &quot;Timeout&quot;: &quot;PT5M&quot;
        }
      }
    },
</code></pre>
<ul>
<li>Ref. <a href="https://www.yamamanx.com/cfn-init-ec2-php-web/">https://www.yamamanx.com/cfn-init-ec2-php-web/</a></li>
</ul>
<p>テストで問われる cfn-signal / WaitCondition のトラブルシューティング</p>
<p><img alt="" src="_attachment/image_1865.png" /></p>
<ul>
<li>プライベートサブネットのインスタンスからシグナルを送るために CloudFormation サービスに NAT 等でアクセスできるようにする必要がある。</li>
</ul>
<h3 id="cfn-hup">cfn-hup</h3>
<ul>
<li>リソースメタデータ (Metadata 属性) の値の変更が検出されたときにカスタムフックを実行するために使用される。</li>
<li>スタック更新で起動中インスタンス内で更新処理を実行したい場合に使う。</li>
<li>デーモンとしてバックグラウンド動作するので通常は UserData で起動する。</li>
</ul>
<p><img alt="" src="_attachment/image_1866.png" /></p>
<ul>
<li>cfn-hup.conf : 監視対象のスタックとポーリングインターバルの指定。</li>
</ul>
<pre><code># The cfn-hup.conf file stores the name of the stack and the AWS credentials that the cfn-hup daemon targets.
&quot;/etc/cfn/cfn-hup.conf&quot;:
  content: !Sub |
    [main]
    stack=${AWS::StackId}
    region=${AWS::Region}
    # The interval used to check for changes to the resource metadata in minutes. Default is 15
    interval=2
  mode: &quot;000400&quot;
  owner: &quot;root&quot;
  group: &quot;root&quot;
</code></pre>
<ul>
<li>hooks.conf: メタデータ更新時のアクションの指定</li>
</ul>
<pre><code># The user actions that the cfn-hup daemon calls periodically are defined in the hooks.conf configuration file.
# To support composition of several applications deploying change notification hooks, cfn-hup supports a directory named hooks.d that is located in the hooks configuration directory. You can place one or more additional hooks configuration files in the hooks.d directory. The additional hooks files must use the same layout as the hooks.conf file.
&quot;/etc/cfn/hooks.d/cfn-auto-reloader.conf&quot;:
  content: !Sub |
    [cfn-auto-reloader-hook]
    triggers=post.update
    path=Resources.WebServerHost.Metadata.AWS::CloudFormation::Init
    action=/opt/aws/bin/cfn-init -v --stack ${AWS::StackName} --resource WebServerHost --region ${AWS::Region}
  mode: &quot;000400&quot;
  owner: &quot;root&quot;
  group: &quot;root&quot;
</code></pre>
<ul>
<li><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/cfn-hup.html">https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/cfn-hup.html</a></li>
</ul>
<p>テンプレートでメタデータを変更してスタック更新してもデフォルトでは何も起こらない。
cfn-hup でメタデータ変更をモニタリングしている場合か、cfn-init を改めて明示的にを実行した場合のみアクションが行われる。</p>
<h3 id="cfn-get-metadata">cfn-get-metadata</h3>
<ul>
<li>リソースメタデータを取得して独自処理をする場合に使用する。</li>
<li>MetaData の内容が JSON で取得される。</li>
</ul>
<pre><code># /opt/aws/bin/cfn-get-metadata --stack CfnHupDemo --resource WebServerHost --region eu-west-1
</code></pre>
<h2 id="_6">リソースの保護</h2>
<p><img alt="" src="_attachment/image_1867.png" /></p>
<h3 id="deletionpolicy_1">DeletionPolicy 属性</h3>
<ul>
<li>スタックが削除される時にリソースを保持(Retain)またはバックアップ(Snapshot)できる。</li>
<li>対象リソースに DeletionPolicy 属性を指定する。</li>
</ul>
<p><img alt="" src="_attachment/image_1868.png" /></p>
<ul>
<li>Delete (default)<ul>
<li><img alt="" src="_attachment/image_1869.png" /></li>
</ul>
</li>
<li>Snapshot をサポートするリソース<ul>
<li>AWS::EC2::Volume</li>
<li>AWS::ElastiCache::CacheCluster</li>
<li>AWS::ElastiCache::ReplicationGroup</li>
<li>AWS::RDS::DBInstance</li>
<li>AWS::RDS::DBCluster</li>
<li>AWS::Redshift::Cluster</li>
</ul>
</li>
<li><img alt="" src="_attachment/image_1870.png" /></li>
</ul>
<h3 id="terminationprotection">TerminationProtection: スタックの削除保護</h3>
<ul>
<li>スタックの削除が実行できなくなる。スタック作成時と作成後にも設定できる。</li>
<li>削除保護を変更すると、ネストされたスタックにも反映される。</li>
<li><a href="https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/using-cfn-protect-stacks.html">https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/using-cfn-protect-stacks.html</a></li>
</ul>
<h3 id="_7">スタックポリシー</h3>
<ul>
<li>スタックにつけられるリソースベースポリシー。</li>
<li>重要なスタックリソースを変更する意図しないスタック更新を拒否できる。</li>
<li>まず全て Allow して、保護したいものを Deny で指定する。</li>
</ul>
<pre><code>{
    &quot;Statement&quot;: [
        {
            &quot;Effect&quot;: &quot;Allow&quot;,
            &quot;Action&quot;: &quot;Update:*&quot;,
            &quot;Principal&quot;: &quot;*&quot;,
            &quot;Resource&quot;: &quot;*&quot;
        },
        {
            &quot;Effect&quot;: &quot;Deny&quot;,
            &quot;Action&quot;: &quot;Update:*&quot;,
            &quot;Principal&quot;: &quot;*&quot;,
            &quot;Resource&quot;: &quot;LogicalResourceId/CriticalSecurityGroup&quot;
        },
        {
            &quot;Effect&quot; : &quot;Deny&quot;,
            &quot;Action&quot; : &quot;Update:*&quot;,
            &quot;Principal&quot;: &quot;*&quot;,
            &quot;Resource&quot; : &quot;*&quot;,
            &quot;Condition&quot; : {
              &quot;StringEquals&quot; : {
                &quot;ResourceType&quot; : [&quot;AWS::RDS::DBInstance&quot;]
              }
            }
        }
    ]
}
</code></pre>
<ul>
<li>Ref. <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/protect-stack-resources.html">https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/protect-stack-resources.html</a></li>
</ul>
<h2 id="_8">ドリフト検出</h2>
<p>CloudFormation 外部でスタックのリソースに直接変更が行われたか検出できる。</p>
<p>AWS コンソールでスタックアクションからドリフト検出を実施し、ドリフト詳細の表示を行う。</p>
<p>スタック全体のステータス:</p>
<ul>
<li>NOT_CHECKED</li>
<li>IN_SYNC</li>
<li>DRIFTED</li>
</ul>
<p>リソースのステータス:</p>
<ul>
<li>NOT_CHECKED</li>
<li>IN_SYNC</li>
<li>DELETED</li>
<li>MODIFIED</li>
</ul>
<p>ネストされたスタックのドリフトは検出しない。ネストされたスタックに対して直接ドリフト検出の実行が必要。</p>
<p><img alt="" src="_attachment/image_1871.png" /></p>
<ul>
<li>動的リファレンス<ul>
<li>SSM Parameter Store や Secrets Manager 等で管理されている外部値を参照する。</li>
<li>テンプレートに機密情報を埋め込まずに済む。</li>
</ul>
</li>
</ul>
<h2 id="_9">カスタムリソース</h2>
<ul>
<li>外部リソースをカスタムリソースプロバイダー (Lambda 等) で作成・更新・削除する。</li>
<li>AWS::CloudFormation::CustomResource</li>
<li>ユースケース:</li>
<li><img alt="" src="_attachment/image_1872.png" /><ul>
<li>空でない S3 バケットではスタック削除が FAIL するため、Lambda カスタムリソースで削除するのは頻出のユースケース。(DeletaionPolicy が Delete でも FAIL する)</li>
<li>Fetch an AMI id はリージョン毎に異なる AMI ID を Lambda カスタムリソースで取得して、カスタムリソースの Attribute として AMI ID を返すようなユースケース。</li>
</ul>
</li>
</ul>
<p><img alt="" src="_attachment/image_1873.png" /></p>
<ul>
<li>Outputs で Export された Lambda を ImportValue してカスタムリソースとして作成している例</li>
</ul>
<pre><code>Resources:
  myBucketResource:
    Type: AWS::S3::Bucket

  LambdaUsedToCleanUp:
    Type: Custom::cleanupbucket
    Properties:
      ServiceToken: !ImportValue EmptyS3BucketLambda
      BucketName: !Ref myBucketResource
</code></pre>
<p>仕組み
- Create/Update/Delete といったリクエストを  SNS メッセージでカスタムリソースプロバイダ に送信する。
- <img alt="" src="_attachment/image_1874.png" />
- リクエストには以下のような値が含まれる:
    - プロパティ属性で渡した値 (ResourceProperties)
    - 応答用の S3 署名付き URL (ResponseURL)
- カスタムリソースプロバイダがメッセージを処理し、Success/Fail の結果が S3 署名付き URL 経由で CloudFormation に返される。
- Lambda を使用する場合は直接 Lambda の ARN を指定でき、SNS トピックを作成する必要がない。</p>
<h2 id="cloudformation_3">CloudFormation スタックセット</h2>
<ul>
<li>クロスアカウント/クロスリージョンに同一スタックを1 度のオペレーションで作成、更新、削除できる。</li>
</ul>
<p><img alt="" src="_attachment/image_1875.png" /></p>
<ul>
<li>ターゲットアカウントにスタックを作成する前に、 管理者アカウントとターゲットアカウントの間に信頼関係をセットアップする必要がある。</li>
<li>スタックセットはリージョンリソースなので、他のリージョンで表示や変更できない。</li>
</ul>
<p><img alt="" src="_attachment/image_1876.png" /></p>
<p>StackSets のテンプレートがある</p>
<p><img alt="" src="_attachment/image_1877.png" /></p>
<p>AWS インフラの中央ロギング</p>
<ul>
<li>CloudFormation テンプレートにより複数アカウントやリージョンからのログファイルを Elasticsearch Service にアップロードするのに必要なコンポーネントの起動・設定が自動的に行われ、ダッシュボードでの分析と可視化を実行できます。</li>
<li>複数のアプリケーションを立ち上げる際にも容易に中央ロギングを AWS 上で展開することが可能になります。</li>
</ul>
<p><img alt="" src="_attachment/image_1878.png" /></p>
<ul>
<li>TaskCat は CloudFormation テンプレートをテストするオープンソー スツールです。</li>
<li>TaskCat では同時に複数リージョンでスタックが作 成され、各リージョンに対して合格か失敗かの判定を示すレポートが生成されます。</li>
<li>リージョンと AZ 数を設定して、テストする CloudFormation パラメータ値を渡すことができます。</li>
</ul>
<h2 id="lambda">Lambda 展開のテンプレート</h2>
<p>例: ZipFile でコードを直書きする場合</p>
<pre><code>Resources:
  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - lambda.amazonaws.com
          Action:
          - sts:AssumeRole
      Path: &quot;/&quot;
      Policies:
      - PolicyName: root
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - &quot;s3:*&quot;
            Resource: &quot;*&quot;
          - Effect: Allow
            Action:
            - &quot;logs:CreateLogGroup&quot;
            - &quot;logs:CreateLogStream&quot;
            - &quot;logs:PutLogEvents&quot;
            Resource: &quot;*&quot;

  ListBucketsS3Lambda:
    Type: &quot;AWS::Lambda::Function&quot;
    Properties:
      Handler: &quot;index.handler&quot;
      Role:
        Fn::GetAtt:
          - &quot;LambdaExecutionRole&quot;
          - &quot;Arn&quot;
      Runtime: &quot;python3.7&quot;
      Code:
        ZipFile: |
          import boto3

          # Create an S3 client
          s3 = boto3.client('s3')

          def handler(event, context):
            # Call S3 to list current buckets
            response = s3.list_buckets()

            # Get a list of all bucket names from the response
            buckets = [bucket['Name'] for bucket in response['Buckets']]

            # Print out the bucket list
            print(&quot;Bucket List: %s&quot; % buckets)

            return buckets
</code></pre>
<p>例: S3 バケットから Lamda コードをアップロードする場合</p>
<ul>
<li>コードを更新する場合 S3ObjectVersionParam のパラメタを更新する。</li>
</ul>
<pre><code>  ListBucketsS3Lambda:
    Type: &quot;AWS::Lambda::Function&quot;
    Properties:
      Handler: &quot;index.handler&quot;
      Role:
        Fn::GetAtt:
          - &quot;LambdaExecutionRole&quot;
          - &quot;Arn&quot;
      Runtime: &quot;python3.7&quot;
      Code:
        S3Bucket:
          Ref: S3BucketParam
        S3Key:
          Ref: S3KeyParam
        S3ObjectVersion:
          Ref: S3ObjectVersionParam
</code></pre>
<hr />
<h1 id="aws-cdk-cloud-development-kit">AWS CDK (Cloud Development Kit/クラウド開発キット)</h1>
<ul>
<li>プログラミング言語から CloudFormation テンプレートの構築・操作をコーディングするライブラリとツールキット。</li>
<li>サポート言語: TypeScript, JavaScript, Python, Java, C#/.Net</li>
</ul>
<p><img alt="" src="_attachment/image_1879.png" /><img alt="" src="_attachment/image_1880.png" /></p>
<ul>
<li>CDK アプリケーション内で、システムに必要なインフラストラクチャスタックを定義します。</li>
<li>そのスタック内では Construct のツリーを定義でき ます。</li>
<li>Construct は AWS CDK アプリケーションの基本的な構成要素です。</li>
<li>Construct は「クラウドコンポーネント」のことを表し、コンポーネントの作成に CloudFormation で必要されるすべての要素をカプセル化しま す。</li>
<li>Construct は S3 バケットなど1 つのリソースを表 すこともあれば、複数の AWS CDK リソースで構成される高レベルのコン ポーネントを表すこともあります。</li>
<li>このようなコンポーネントの例としては、 コンピューティング性能が関連付けされたワーカーキュー、モニタリングリソースとダッシュボードを備えた cron ジョブ、さらには複数の AWS ア カウントとリージョンにまたがるアプリケーション全体などが挙げられます。</li>
</ul>
<p>コード例</p>
<p><img alt="" src="_attachment/image_1881.png" /></p>
<ul>
<li>素の CloudFormation テンプレートに比べてある程度リソースを自動で作ってくれる。</li>
<li>例えば VPC を作ると関連するリソースも自動的に作ってくれる。</li>
</ul>
<p><img alt="" src="_attachment/image_1882.png" /></p>
<hr />
<h1 id="aws-elastic-beanstalk">AWS Elastic Beanstalk</h1>
<ul>
<li>Web アプリのデプロイ・プロビジョニング・モニタリング。</li>
<li>Beanstalk（びーんすとーく）は「豆の木」。</li>
</ul>
<p><img alt="" src="_attachment/File_275.png" /></p>
<ul>
<li>Apache, Nginx, IIS などの Web アプリケーションサーバーに対応。</li>
<li>プロビジョニング・負荷分散・アプリケーションのモニタリングなどを自動設定:<ul>
<li>EC2, EBS, RDS, セキュリティグループ, IAM ロール</li>
<li>ELB, Auto Scaling</li>
<li>CloudWatch Alarms, SNS</li>
</ul>
</li>
<li>プラットフォームのアップデート。</li>
<li>デプロイしたアプリのバージョニングやロールバックも。</li>
<li>Web サーバ環境と Worker 環境 (Web server tier &amp; Worker tier)</li>
</ul>
<p><img alt="" src="_attachment/File_276.png" /></p>
<p>言語とプラットフォーム</p>
<p><img alt="" src="_attachment/File_277.png" /></p>
<ul>
<li>各種言語にまじって Docker もある。</li>
<li>多様な役割のコンテナのデプロイとオーケストレーションには ECS/EKS を使用する。</li>
</ul>
<p><img alt="" src="_attachment/File_278.png" /></p>
<p>アプリケーション</p>
<ul>
<li>環境、環境設定、バージョンの入れ物</li>
<li>複数環境を起動できる。</li>
</ul>
<p>環境</p>
<ul>
<li>インフラ環境 (Web/Worker )</li>
<li>アプリケーションバージョン (アプリのコード) をデプロイする。</li>
</ul>
<p><img alt="" src="_attachment/image_1883.png" /></p>
<p>アプリケーションバージョン</p>
<p>eb deploy するたびにアプリケーションバージョンができる</p>
<p><img alt="" src="_attachment/image_1884.png" /></p>
<ul>
<li>ライフサイクル<ul>
<li>保持期限を個数又は日数で管理する</li>
</ul>
</li>
<li><img alt="" src="_attachment/image_1885.png" /></li>
</ul>
<p>環境のタイプ: 単一インスタンスと負荷分散 (Single-instance / Load balanced)</p>
<p>Load balanced にすると ELB と Auto Scaling が付き、Multi-AZ にできる。</p>
<p><img alt="" src="_attachment/image_1886.png" /></p>
<h3 id="_10"><br></h3>
<h3 id="eb-cli">EB CLI</h3>
<p><a href="https://docs.aws.amazon.com/ja_jp/elasticbeanstalk/latest/dg/eb-cli3.html">https://docs.aws.amazon.com/ja_jp/elasticbeanstalk/latest/dg/eb-cli3.html</a></p>
<p>eb init</p>
<ul>
<li>アプリケーションを作成。</li>
</ul>
<p>eb create</p>
<ul>
<li>環境 (ランタイム環境) を作成。リソースの展開には CloudFormation が使われる。</li>
</ul>
<p>eb deploy</p>
<ul>
<li>変更を環境にデプロイ。</li>
</ul>
<p>eb terminate</p>
<ul>
<li>環境の終了。</li>
</ul>
<p>eb open</p>
<p>eb status</p>
<p>eb health</p>
<p>eb logs</p>
<p>保存済み設定: Saved configurations</p>
<p>起動中の環境設定を保存して他のリージョンやアカウントで展開できる</p>
<p>eb config save dev-env --cfg prod</p>
<ul>
<li>サービス側に Saved Configuration が保存される。</li>
<li>.elasticbeanstalk/saved_configs 配下に prod.cfg.yaml ができる。</li>
<li>ローカルで直に yaml ファイルを編集できる。(.ebextensions でも同様)</li>
</ul>
<p>eb config put prod</p>
<ul>
<li>ローカルで編集した yaml ファイルをサービス側に保存する。</li>
</ul>
<p>eb config dev-env --cfg prod</p>
<ul>
<li>サービス側に保存された Saved Configuration を環境に適用。</li>
</ul>
<h2 id="ebextensions">.ebextensions ディレクトリ</h2>
<p>環境の設定・リソースの高度なカスタマイズが可能。</p>
<p>操作を指定した (分割された) コンフィグファイルを配置する。</p>
<p>ローカルで編集して eb deploy で環境に適用する。</p>
<p><img alt="" src="_attachment/image_1887.png" /></p>
<p>services:</p>
<ul>
<li>各種サービスのコンフィグを設定: EC2, VPC, Auto Scaling, ELB, RDS  等。<ul>
<li><a href="https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/command-options-general.html">https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/command-options-general.html</a></li>
</ul>
</li>
</ul>
<p>resources:</p>
<ul>
<li>CloudFromation テンプレートのリソース記述で任意のリソースを作成できる。</li>
<li>ただし DB のように消えたら困るリソースは環境外に個別に作成したほうがよい。</li>
</ul>
<pre><code>Resources:
  DynamoDBTable:
    Type: AWS::DynamoDB::Table
    Properties:
      KeySchema:
        HashKeyElement:
          AttributeName: id
          AttributeType: S
      # create a table with the least available rd and wr throughput
      ProvisionedThroughput:
        ReadCapacityUnits: 1
        WriteCapacityUnits: 1

  NotificationTopic:
    Type: AWS::SNS::Topic

Outputs:
  NotificationTopicArn:
    Description: Notification topic ARN
    Value: { &quot;Ref&quot; : &quot;NotificationTopic&quot; }

option_settings:
  aws:elasticbeanstalk:application:environment:
    # these are assigned dynamically during a deployment
    NOTIFICATION_TOPIC: '`{&quot;Ref&quot; : &quot;NotificationTopic&quot;}`'
    DYNAMODB_TABLE: '`{&quot;Ref&quot; : &quot;DynamoDBTable&quot;}`'
    AWS_REGION: '`{&quot;Ref&quot; : &quot;AWS::Region&quot;}`'
</code></pre>
<p>コマンド実行:</p>
<ul>
<li>commands:<ul>
<li>アプリケーションバージョンのファイルが解凍される前に実行される</li>
</ul>
</li>
</ul>
<pre><code># You can use the commands key to execute commands on the EC2 instance. The commands run before the application and web server are set up and the application version file is extracted.
commands:
  create_hello_world_file:
    command: touch hello-world.txt
    cwd: /home/ec2-user
</code></pre>
<ul>
<li><a href="https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/customize-containers-ec2.html#linux-commands">https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/customize-containers-ec2.html#linux-commands</a></li>
<li>container_commands:<ul>
<li>アプリケーションバージョンのファイルがステージングフォルダに解凍された後に実行される</li>
<li>設定ファイルを変更したりはできるが、デプロイよりも前であることに注意。</li>
</ul>
</li>
</ul>
<pre><code># You can use the container_commands key to execute commands that affect your application source code. Container commands run after the application and web server have been set up and the application version archive has been extracted, but before the application version is deployed.
container_commands:
  modify_index_html:
    command: 'echo &quot; - modified content&quot; &gt;&gt; index.html'

  database_migration:
    command: 'echo &quot;do a database migration&quot;'
    # You can use leader_only to only run the command on a single instance
    leader_only: true
</code></pre>
<pre><code>- leader\_only: true ... 複数あるインスタンスのうち１つだけで実行する。
</code></pre>
<ul>
<li><a href="https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/customize-containers-ec2.html#linux-container-commands">https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/customize-containers-ec2.html#linux-container-commands</a></li>
</ul>
<p>Container Commands vs Commands?</p>
<ul>
<li><a href="https://stackoverflow.com/questions/35788499/what-is-difference-between-commands-and-container-commands-in-elasticbean-talk/40096352#40096352">https://stackoverflow.com/questions/35788499/what-is-difference-between-commands-and-container-commands-in-elasticbean-talk/40096352#40096352</a></li>
</ul>
<p>hooks フォルダ</p>
<ul>
<li>デプロイ後にコマンド実行するには files セクションで appdeploy フォルダにスクリプトを作成する</li>
<li>/opt/elasticbeanstalk/hooks/ 配下の以下のフォルダ<ul>
<li>preinit - アプリケーションのデプロイ前</li>
<li>appdeploy - アプリケーションのデプロイ中</li>
<li>postinit - アプリケーションのデプロイ後</li>
<li>configdeploy - ユーザによる設定変更時</li>
<li>restartappserver - ユーザによるリスタート時</li>
</ul>
</li>
<li><a href="https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/custom-platform-hooks.html">https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/custom-platform-hooks.html</a></li>
</ul>
<p>設定の優先順位</p>
<ol>
<li>環境に直接 API (CLI) で適用される設定</li>
<li>保存済み設定</li>
<li>設定ファイル (.ebextensions)</li>
<li>デフォルト値</li>
</ol>
<h2 id="_11">デプロイポリシー</h2>
<p>Ref. <a href="AWS%20-%20Deployment%20Strategy.html">AWS - Deployment Strategy</a></p>
<ul>
<li>All at once</li>
<li>Rolling</li>
<li>Rolling with additional batch</li>
<li>Immutable</li>
</ul>
<h2 id="worker">Worker 環境</h2>
<p>SQS キューのリッスンまたはスケジュールでタスクを処理する Worker アプリケーション。</p>
<p>スケジュールは cron.yaml で設定。</p>
<p>Web サーバ環境の背後で時間のかかる処理を非同期で行うのが目的。</p>
<p><img alt="" src="_attachment/image_1888.png" /></p>
<p><a href="https://docs.aws.amazon.com/ja_jp/elasticbeanstalk/latest/dg/using-features-managing-env-tiers.html">https://docs.aws.amazon.com/ja_jp/elasticbeanstalk/latest/dg/using-features-managing-env-tiers.html</a></p>
<p>ワーカー環境では Amazon SQS キューを管理し、キューから読み取る各インスタンスでデーモンプロセスを自動的に実行します。デーモンは、キューから項目を取得すると、キューメッセージの内容を本文に含めて、HTTP POST リクエストをローカルにポート 80 の http://localhost/ に送信します。アプリケーションに必要なのは、POST に応じて実行時間が長いタスクを実行することだけです。デーモンを設定し、別のパスに送信する、application/JSON 以外の MIME タイプを使用する、既存のキューに接続する、または接続 (最大の同時リクエスト数)、タイムアウト、再試行をカスタマイズすることができます。</p>
<p>定期的なタスクでは、cron スケジュールに基づいてメッセージをキューに入れるようワーカーデーモンを設定することもできます。定期的な各タスクでは、別のパスに POST できます。各タスクのスケジュールおよびパスを定義するソースコードに YAML ファイルを含めて、定期的なタスクを有効にします。(cron.yaml)</p>
<p>Web Server 環境と Woker 環境の連携の図</p>
<p><img alt="" src="_attachment/image_1889.png" /></p>
<h2 id="docker-in-beanstalk">Docker in Beanstalk</h2>
<p>プラットフォームに Docker を選ぶ場合 ECS を利用できる。</p>
<p><img alt="" src="_attachment/image_1890.png" /><img alt="" src="_attachment/image_1891.png" /></p>
<h2 id="_12"><br></h2>
<p>環境の Web サーバなどのパッチ適用の自動化もできる:</p>
<p><img alt="" src="_attachment/image_1892.png" /></p>
<hr />
<h1 id="aws-opsworks">AWS OpsWorks</h1>
<ul>
<li>Chef または Puppet のマネージドサービス。</li>
<li>EC2 インスタンス内のサーバ構成をオートメーション。<ul>
<li>サーバのパッチ適用、アップデート、バックアップが自動的に実行されるらしい。</li>
</ul>
</li>
<li>既存の Chef クックブック/レシピを再利用できる。</li>
<li>AWS とオンプレ両方管理できる。</li>
</ul>
<p><img alt="" src="_attachment/File_279.png" /></p>
<h3 id="3">3つのサービス</h3>
<p>AWS OpsWorks Stacks</p>
<p>AWS OpsWorks for Puppet Enterprise</p>
<ul>
<li>Puppet Enterprise のフルマネージド型サービ ス。</li>
<li>Puppet プライマリサーバを管理し、パッチ適用・更新・バックアップを自動的に実行。</li>
</ul>
<p>AWS OpsWorks for Chef Automate</p>
<ul>
<li>Chef Automate サーバのフルマネージド型サービ ス。</li>
</ul>
<h2 id="opsworks">OpsWorks スタック</h2>
<p><img alt="" src="_attachment/image_1893.png" /></p>
<p>スタック</p>
<ul>
<li>ロードバランサー層、アプリケーションサーバ層、DB などの複数レイヤの AWS リソースのスタック</li>
<li>Chef サーバは作成されません。OpsWorks スタックは Chef サーバの機能の一部を実行します。</li>
</ul>
<p>レイヤー</p>
<ul>
<li>DB レイヤー等、レイヤー毎の機能を実現するインスタンスのセット。</li>
<li>インスタンスタイプ: 24/7, Time-based, Load-based</li>
</ul>
<p><img alt="" src="_attachment/image_1894.png" /></p>
<ul>
<li>Time-based instances<ul>
<li>They allow a stack to handle loads that follow a predictable pattern by including instances that run only at certain times or on certain days.</li>
<li>For example, you could start some instances after 6PM to perform nightly backup tasks or stop some instances on weekends when traffic is lower.</li>
</ul>
</li>
<li>Load-based instances<ul>
<li>They allow a stack to handle variable loads by starting additional instances when traffic is high and stopping instances when traffic is low, based on any of several load metrics.</li>
<li>For example, you can have AWS OpsWorks Stacks start instances when the average CPU utilization exceeds 80% and stop instances when the average CPU load falls below 60%.</li>
</ul>
</li>
</ul>
<p>クックブックレポジトリ</p>
<ul>
<li>Git, S3, HTTP 等の Chef クックブック保存先。</li>
</ul>
<p>アプリケーション</p>
<ul>
<li>アプリケーションコードは Git, S3 などのリポジ トリに保存される。</li>
<li>インスタンスにアプリケーションをデプロイする際、OpsWorks スタックによって「Deploy」ライフサイクルイベントがトリガーさ れ、レイヤーのデプロイレシピがそのインスタンスで実行される。</li>
</ul>
<h3 id="_13">ライフサイクルイベント/レシピ</h3>
<p>各レイヤーでライフサイクルイベントごとに実行するレシピ (Chef cookbook) を指定できる。</p>
<p><a href="https://docs.aws.amazon.com/opsworks/latest/userguide/workingcookbook-events.html">https://docs.aws.amazon.com/opsworks/latest/userguide/workingcookbook-events.html</a></p>
<p>Each layer has a set of five lifecycle events, each of which has an associated set of recipes that are specific to the layer. When an event occurs on a layer's instance, AWS OpsWorks Stacks automatically runs the appropriate set of recipes.</p>
<p><img alt="" src="_attachment/image_1895.png" /></p>
<p>Setup</p>
<ul>
<li>This event occurs after a started instance has finished booting.</li>
</ul>
<p>Configure</p>
<ul>
<li>This event occurs on all of the stack's instances when one of the following occurs:<ul>
<li>An instance enters or leaves the online state.</li>
<li>You associate an EIP address with an instance or disassociate one from an instance.</li>
<li>You attach an ELB to a layer, or detach one from a layer.</li>
</ul>
</li>
<li>いずれか1つのインスタンスがオンライン/オフラインになった際に全てのインスタンスで実行される。</li>
</ul>
<p>Deploy</p>
<ul>
<li>This event occurs when you run a Deploy command, typically to deploy an application to a set of application server instances.</li>
</ul>
<p>Undeploy</p>
<ul>
<li>This event occurs when you delete an app or run an Undeploy command to remove an app from a set of application server instances.</li>
</ul>
<p>Shutdown</p>
<ul>
<li>This event occurs after you direct OpsWorks Stacks to shut an instance down but before the associated  EC2 instance is actually terminated.</li>
</ul>
<p>問題例</p>
<p>You are working as a DevOps engineer for a leading telecommunications company which is planning to host a distributed system in AWS. Their system must be hosted on multiple Linux-based application servers which must use the same configuration file that tracks any changes in the cluster such as adding or removing a server. The configuration file is named as <em>tdojo-nodes.config</em> which contains the list of private IP addresses of the servers in the cluster and other metadata.</p>
<p>Which of the following is the MOST automated way to meet the above requirements?</p>
<p>解答</p>
<p>Layer the application server nodes of the cluster using AWS OpsWorks Stacks and add a Chef recipe associated with the <strong>Configure</strong> Lifecycle Event which populates the <em>tdojo-nodes.config</em> file. Set up a configuration which runs each layer's <strong>Configure</strong> recipes that updates the configuration file when a cluster change is detected.</p>
<p>自動ヒーリング</p>
<ul>
<li>OpsWorks Stacks agent との疎通確認でインスタンスのヘルスチェック。</li>
<li>Fail すると自動ヒーリングが新しいインスタンスのプロビジョンを実行する。</li>
<li>Fail のイベントは EventBridge で監視できる。</li>
<li><img alt="" src="_attachment/image_1896.png" /></li>
<li><a href="https://docs.aws.amazon.com/opsworks/latest/userguide/workinginstances-autohealing.html">https://docs.aws.amazon.com/opsworks/latest/userguide/workinginstances-autohealing.html</a></li>
<li>問題例: The DevOps team should receive an email whenever AWS OpsWorks restarts an instance that is considered unhealthy or unable to communicate with the service endpoint.</li>
<li><img alt="" src="_attachment/image_1897.png" /></li>
</ul>
<p><br></p>
</article>

    </main>
    <footer>
        <p>&copy; 2025 AWS DevOps Notes</p>
    </footer>
    <script src="static/script.js"></script>
</body>
</html>