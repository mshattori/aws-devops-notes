<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>AWS - Deployment Strategy - AWS DevOps Notes</title>
    <link rel="stylesheet" href="static/style.css">
</head>
<body>
    
    <header>
        <h1>AWS - Deployment Strategy</h1>
    </header>
    
    <main>
        
<article>
    <p>デプロイ戦略概要</p>
<h2 id="_1">用語</h2>
<p>カットオーバー
- 新バージョンまたは別システムへの移行</p>
<p>ダークローンチ
- フィーチャーフラグで一部インスタンスのみで機能を有効化。</p>
<p>セグメンテーション
- デプロイを小さなチャンクに分割することでリスク軽減。
- リージョン, AZ, インスタンスごとなどで分割。
- タグや Auto Scaling グループでグループ化。</p>
<p><img alt="" src="_attachment/image_512.png" /></p>
<p>インプレース vs イミュータブル (ホスト環境の継続利用 vs 置き換え)
- インプレース
  - 稼働中インスタンスを落とさずにデプロイ。
  - インスタンスが並列しないので低コスト。
  - CodeDeploy, Beanstalk, OpsWorks でサポート。
- イミュータブル
  - インプレースの反対。新しいインスタンス・並列環境を作ってデプロイ。
  - EC2 Auto Scaling: AutoScalingReplacingUpdate</p>
<p>ローリング vs Blue/Green (ターゲットグループ=本番環境が単一 vs 並列)
- ローリング
  - 稼働中インスタンスを一部切り離してデプロイし、再びオンラインに戻すを繰り返す。
  - ダウンタイムなし。
  - インプレース/イミュータブル両方可能。
  - CodeDeploy: インプレースの OneAtATime, HalfAtATime
  - Beanstalk: ローリング, 追加バッチとローリング
  - EC2 Auto Scaling: AutoScalingRollingUpdate: 既存 Auto Scaling グループ内で新しいインスタンスを立ててローリングアップデート
- Blue/Green
  - Blue/Green の２つの並列環境を作成してトラフィックを振り分け。
  - ロールバックが容易。
  - トラフィックルーティングの仕組みが必要。
  - 原理的にイミュータブル。
  - CodeDeploy, Beanstalk, OpsWorks, CloudFormation
  - デプロイ設定 (Deployment configuration)
    - AllAtOnce: 一度で切り替え
    - Canary: 比率を指定して２段階目で切り替え
    - Linear: 段階的に振り分け</p>
<p>カナリアリリース (Canary Release)
- 目的：新バージョンの安全性検証。小さな割合→段階的に比率を増やす。
- 典型実装：Blue/Green + 重み付きトラフィックシフト（10%→50%→100%）。
- 成果判断：障害/エラーレート/レイテンシ等の品質指標。問題なら即ロールバック。</p>
<p>A/B デプロイ (A/B テスト)
- 目的：複数バリアントの効果比較。置換は前提でない（併存して長期運用も）。
- 典型実装：トラフィック分割（50/50 等）＋ユーザ割当の一貫性（クッキー/ID）。</p>
<p>成果判断：統計検定・サンプルサイズ設計等の実験デザインが中核</p>
<h1 id="bluegreen">Blue/Green デプロイ</h1>
<p>概要</p>
<ul>
<li>ブルー (既存環境) / グリーン (新しいバージョン) をスイッチ</li>
<li>一般的な手法<ul>
<li>DNS カットオーバー</li>
<li>Auto Scaling グループの交換</li>
</ul>
</li>
</ul>
<h2 id="aws">AWS での実現方法</h2>
<p>Ref. <a href="https://d1.awsstatic.com/whitepapers/AWS_Blue_Green_Deployments.pdf">https://d1.awsstatic.com/whitepapers/AWS_Blue_Green_Deployments.pdf</a></p>
<h3 id="route53-cname-allatonce">Route53 CNAME 切り替え (AllAtOnce)</h3>
<ul>
<li>エイリアス (CNAME) が指す ELB の DNS 名を切り替える。</li>
</ul>
<p><img alt="" src="_attachment/File_3.png" /><img alt="" src="_attachment/image_513.png" /></p>
<h3 id="route53">Route53 加重ラウンドロビン</h3>
<ul>
<li><img alt="" src="_attachment/File_4.png" /></li>
</ul>
<h3 id="elb">ELB ターゲットグループ切り替え</h3>
<ul>
<li>Blue に加えて Green の Auto Scaling グループを ELB のターゲットに登録。</li>
<li>Blue のインスタンスを段階的にスケールインして減らしていく。</li>
</ul>
<p><img alt="" src="_attachment/image_514.png" /></p>
<h3 id="alb">ALB 加重ターゲットグループ</h3>
<ul>
<li>Blue/Green のターゲットグループに重みを指定。</li>
<li><img alt="" src="_attachment/image_515.png" /></li>
<li><br></li>
</ul>
<h3 id="auto-scaling">Auto Scaling スケールアウト/スケールイン</h3>
<ul>
<li>デフォルトの終了ポリシーが古い起動設定により起動されたインスタンスから終了させることを利用。起動テンプレートでAMIを変更後、インスタンス数を増やしてから減らすと自動的に古いインスタンスがなくなる。</li>
<li>1. Auto Scaling グループの起動設定を変更して新しい AMI を指定。</li>
<li>2. 手動スケーリングで希望容量を 4 から 8 に増やす。新しいインスタンスが 4 加わる。</li>
<li>4. 希望容量を 4 に戻す。古いインスタンスが終了される。</li>
<li><a href="https://www.yamamanx.com/wordpress-update-blue-green/">https://www.yamamanx.com/wordpress-update-blue-green/</a></li>
</ul>
<h3 id="api-gateway">API Gateway</h3>
<ul>
<li>Canary ステージを作成して比率を指定。</li>
<li><img alt="" src="_attachment/File_5.png" /></li>
</ul>
<h3 id="lambda">Lambda 加重エイリアス</h3>
<ul>
<li>route-config でセカンダリのバージョンと比率を設定。</li>
<li>ユースケース例: API Gateway フロントの Lambda 関数の Blue/Green を API Gateway 側の設定を変更せずに実施できる。</li>
</ul>
<h3 id="sam-awsserverlessfunction">SAM の AWS::Serverless::Function</h3>
<ul>
<li>DeploymentPreference プロパティでカナリアリリースを指定できる。</li>
</ul>
<h3 id="codedeploy">CodeDeploy</h3>
<ul>
<li>EC2, オンプレ:  ALB の加重ターゲットグループで移行。</li>
<li>ECS: サービスに新しいタスクセットを作成、ELB の加重ターゲットグループで移行。</li>
<li>Lambda: 加重エイリアスを使用。</li>
</ul>
<h3 id="elastic-beanstalk">Elastic Beanstalk</h3>
<ul>
<li>eb clone/swap による DNS カットオーバー</li>
<li>eb deploy の展開タイプ<ul>
<li>All at once ... インプレースで全部デプロイ<ul>
<li>全インスタンスが一旦停止。</li>
</ul>
</li>
<li>Rolling / Rolling with additional batch ... ローリング <ul>
<li>ELB ターゲットグループのインスタンス入れ替え。</li>
</ul>
</li>
<li>Immutable ... イミュータブル <ul>
<li>Auto Scaling グループの交換。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="cloudformation">CloudFormation</h3>
<p>各サービスのデプロイ方式を設定可能
- <strong>UpdatePolicy（ASGの更新方式）</strong>
    - <strong>AutoScalingRollingUpdate</strong>：同一ASG内で<strong>ローリング更新</strong>。
        - <strong>MinInstancesInService</strong>（稼働を維持する最小台数）
        - <strong>MaxBatchSize</strong>（一度に入れ替える台数）
        - <strong>PauseTime</strong>（各バッチ後の待機。<code>PT5M</code>などISO8601）
        - <strong>WaitOnResourceSignals</strong>（<code>true</code>なら<code>cfn-signal</code>待ち）
    - <strong>AutoScalingReplacingUpdate</strong>：<strong>ASGを置換</strong>（Blue/Green）。
        - <strong>WillReplace: true</strong> → <strong>新ASGを作って切替</strong>（丸ごと置換）
        - <strong>WillReplace: false</strong> → 置換しない（=ローリング側設定を使う想定）
- <strong>CreationPolicy（リソース完成待ち）</strong>
    - <strong>ResourceSignal</strong> と <strong><code>cfn-signal</code></strong> を<strong>WaitOnResourceSignals</strong>とセットで使う。
    - 目的：<strong>インスタンスの初期化（UserData等）完了をCFnが待つ</strong>。
- <strong>ASG ローリング</strong></p>
<pre><code class="language-yaml">    UpdatePolicy:
      AutoScalingRollingUpdate:
        MinInstancesInService: 4
        MaxBatchSize: 2
        PauseTime: PT5M
        WaitOnResourceSignals: true
    CreationPolicy:
      ResourceSignal:
        Timeout: PT10M
</code></pre>
<ul>
<li>**ASG 全置換 (Blue/Green) **</li>
</ul>
<pre><code class="language-yaml">    UpdatePolicy:
      AutoScalingReplacingUpdate:
        WillReplace: true
</code></pre>
<ul>
<li><strong>ECS::Service &gt; DeploymentController</strong><ul>
<li><strong>Type: ECS</strong> → <strong>ECSネイティブのローリング</strong><ul>
<li><code>MinimumHealthyPercent</code> / <code>MaximumPercent</code> を設定</li>
</ul>
</li>
<li><strong>Type: CODE_DEPLOY</strong> → <strong>CodeDeployでBlue/Green</strong><ul>
<li>試験では“Blue/Greenを実現するのはどれ？”の選択肢で問われやすい</li>
</ul>
</li>
</ul>
</li>
</ul>
<pre><code class="language-yaml">    Type: AWS::ECS::Service
    Properties:
      DeploymentController:
        Type: CODE_DEPLOY
</code></pre>
<ul>
<li><strong>Lambda の段階配分</strong><ul>
<li><strong>Lambda Alias の RoutingConfig</strong> で<strong>重み付け配分</strong>可能。</li>
<li>本格的な<strong>自動ロールバック</strong>や<strong>アラーム連動</strong>は <strong>CodeDeploy</strong> 側が得意。</li>
</ul>
</li>
<li><strong>UpdateReplacePolicy / DeletionPolicy</strong><ul>
<li>置換・削除時の<strong>リソース保持/スナップショット/削除</strong>を制御。</li>
<li>よく出る組み合わせ：<strong>RDS/S3</strong> で <strong><code>Snapshot</code></strong>、<strong>S3バケット</strong>は<strong><code>Retain</code></strong>に注意。</li>
</ul>
</li>
<li><strong>Change Sets</strong><ul>
<li><strong>本適用前に差分を可視化</strong>してリスク低減。</li>
<li>本番環境での<strong>安全な変更手順</strong>として押さえる。</li>
</ul>
</li>
</ul>
<h3 id="opsworsk">OpsWorsk</h3>
<hr />
<h1 id="codedeploy_1">CodeDeploy のデプロイタイプ</h1>
<p>EC2/オンプレ</p>
<ul>
<li>インプレース (=ローリング)</li>
<li>Blue/Green (=イミュータブル)</li>
</ul>
<p>ECS, Lamda</p>
<ul>
<li>Blue/Green (仕組み的にコンテナやLambdaはインプレース切り替えの概念がない)</li>
</ul>
<p>デプロイ設定</p>
<p><img alt="" src="_attachment/image_516.png" /></p>
<h3 id="ec2">EC2/オンプレ</h3>
<p>インプレース(=ローリング)</p>
<ul>
<li>稼働中サーバを停止せずに新バージョンのアプリを配置/起動する。</li>
<li>各インスタンスでアプリを停止後、新リビジョンをインストールして起動・検証。</li>
</ul>
<p>Blue/Green デプロイ(=イミュータブル)</p>
<ul>
<li>Green のインスタンス群を起動、新リビジョンをインストールして起動・検証。</li>
<li>ELB で実現されるので ELB が必須。</li>
<li>検証を通った Green インスタンスを ELB に登録し、Blue インスタンスを登録解除。</li>
<li><img alt="" src="_attachment/File_6.png" /></li>
<li>Auto Scaling グループの自動コピー: デプロイグループに Auto Scaling グループを指定した場合。Auto Scaling グループ全体の置き換えによるデプロイメントを行う。</li>
<li>Auto Scaling グループの自動コピーを指定しない場合、deployment 作成時に個別にインスタンスを指定することになる。</li>
<li><img alt="" src="_attachment/image_517.png" /></li>
</ul>
<p><img alt="" src="_attachment/image_518.png" /><img alt="" src="_attachment/image_519.png" /></p>
<p>カスタム</p>
<ul>
<li>Half の代わりの割合か台数で必要な稼働中インスタンス数を指定する。</li>
<li><img alt="" src="_attachment/image_520.png" /></li>
</ul>
<h3 id="ecs">ECS</h3>
<p>サービスに新しいタスクセットを作成、ELB の加重ターゲットグループで移行。</p>
<ul>
<li>CloudFormation スタックによる Blue/Green デプロイもある。</li>
</ul>
<p><img alt="" src="_attachment/image_521.png" /></p>
<ul>
<li>Canary は2段階。Liner は10%ずつ段階的に。</li>
</ul>
<h3 id="lambda_1">Lambda</h3>
<p>新しいバージョンを発行し、加重エイリアスを使う。</p>
<ul>
<li>エイリアスはバージョンへのポインタ。別バージョンに簡単に切り替えられる。</li>
<li>加重エイリアスは2つのバージョンへのルーティング比率を指定する。</li>
</ul>
<p><img alt="" src="_attachment/image_522.png" /></p>
<p>Ref. <a href="https://docs.aws.amazon.com/ja_jp/codedeploy/latest/userguide/deployment-configurations.html">https://docs.aws.amazon.com/ja_jp/codedeploy/latest/userguide/deployment-configurations.html</a></p>
<h1 id="elastic-beanstalk_1">Elastic Beanstalk のデプロイ</h1>
<h3 id="deployment-policy">デプロイポリシー (Deployment policy)</h3>
<p><img alt="" src="_attachment/image_523.png" /></p>
<p>All at once</p>
<ul>
<li>単純なインプレースデプロイ。新バージョンを全インスタンスに同時展開。</li>
<li>環境の全インスタンスのアプリケーションが短時間停止する。</li>
<li>展開終了までの合計時間は最短。インスタンスの追加コストなし。</li>
</ul>
<p>Rolling</p>
<ul>
<li>環境のインスタンスを複数バッチに分割、バッチごとに新バージョンをデプロイ。</li>
<li>バッチサイズ分のインスタンスを LB からデタッチしてデプロイ実施。ヘルスチェックが通ればそのバッチを LB に再アタッチ。全インスタンスにデプロイがされるまで繰り返し。</li>
<li>インスタンスの追加コストなし。</li>
<li><img alt="" src="_attachment/image_524.png" /></li>
</ul>
<p>Rolling with additional batch</p>
<ul>
<li>バッチサイズ分の新しいインスタンスにデプロイして環境に追加した後でローリングを実行。</li>
<li>追加バッチのインスタンスは最終的には消去される。</li>
<li><img alt="" src="_attachment/image_525.png" /></li>
</ul>
<p>Immutable</p>
<ul>
<li>別の Auto Scaling グループを作成して新バージョンを展開したインスタンスのフルセットを起動。</li>
<li>新しいインスタンスでヘルスチェックが FAIL した場合は終了し、元のインスタンスをそのまま残す。(FAIL 時のロールバックが迅速)</li>
<li>Blue のインスタンスは削除されるのでイミュータブル。</li>
<li>一時的にインスタンスコストが二倍になるがロールバックが容易。</li>
<li><img alt="" src="_attachment/image_526.png" /></li>
</ul>
<p><img alt="" src="_attachment/image_527.png" /></p>
<ul>
<li><a href="https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/using-features.deploy-existing-version.html">https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/using-features.deploy-existing-version.html</a></li>
</ul>
<h3 id="bluegreen_1">手動 Blue/Green デプロイ</h3>
<ul>
<li>eb clone で既存スタックのクローンを作成後、新バージョンをデプロイしてテスト。</li>
<li>eb swap で内部の CNAME を既存スタックから新スタックに切り替え。(DNS カットオーバー)</li>
</ul>
<p><img alt="" src="_attachment/File_7.png" /><img alt="" src="_attachment/image_528.png" /><img alt="" src="_attachment/image_529.png" /></p>
<h1 id="ecs_1">ECS のデプロイ</h1>
<h2 id="deploymentcontroller">サービスの deploymentController 設定</h2>
<p>次のいずれかに設定する:</p>
<ul>
<li>ECS<ul>
<li>ローリング更新</li>
</ul>
</li>
<li>CODE_DEPLOY<ul>
<li>Blue/Green</li>
</ul>
</li>
<li>EXTERNAL<ul>
<li>ECS API でサービス・タスクを制御する外部のデプロイコントローラー</li>
</ul>
</li>
<li>Ref. <a href="https://docs.aws.amazon.com/ja_jp/AmazonECS/latest/userguide/service_definition_parameters.html">https://docs.aws.amazon.com/ja_jp/AmazonECS/latest/userguide/service_definition_parameters.html</a></li>
</ul>
<h2 id="ecs_2">ECS (ローリング更新)</h2>
<p>サービスのタスク定義を更新すると ECS はローリングデプロイを実施する。</p>
<p>ECS は古いバージョ ンのコンテナへの接続をドレイニングし、新しいコンテナを ALB に登録する。</p>
<p><img alt="" src="_attachment/image_530.png" /></p>
<h2 id="codedeploy-bluegreen">CodeDeploy (Blue/Green)</h2>
<p>本番トラフィックの送信前に Hooks の Lambda でデプロイを検証できる。</p>
<p><img alt="" src="_attachment/image_531.png" /></p>
</article>

    </main>
    <footer>
        <p>&copy; 2025 AWS DevOps Notes</p>
    </footer>
    <script src="static/script.js"></script>
</body>
</html>