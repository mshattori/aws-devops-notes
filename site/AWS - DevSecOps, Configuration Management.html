<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>AWS - DevSecOps, Configuration Management - AWS DevOps Notes</title>
    <link rel="stylesheet" href="static/style.css">
</head>
<body>
    
    <header>
        <h1>AWS - DevSecOps, Configuration Management</h1>
    </header>
    
    <main>
        
<article>
    <p>DevSecOps は DevOps 同様にセキュリティプラクティスをパイプラインで自動化する。</p>
<p><img alt="" src="_attachment/image_376.png" /></p>
<p>パイプライン自体のセキュリティ:</p>
<ul>
<li>パイプラインへのアクセス権の管理:<ul>
<li>最小権限で許可するアクションとリソースを定義。</li>
<li>IAM ロールを使用し、ユーザにポリシーを直接つけない。</li>
<li>MFA を有効にする。</li>
<li>IAM Policy Simulator によるポリシーのテスト。</li>
</ul>
</li>
<li>AWS Config により非準拠リソースを監査。</li>
<li>認証情報の管理<ul>
<li>Secrets Manager, SSM Parameter Store を使う。</li>
</ul>
</li>
<li>Jenkins などのビルドーサーバを保護する。</li>
</ul>
<p>パイブライン内のセキュリティ:</p>
<ul>
<li>セキュリティテストの実施。</li>
</ul>
<h1 id="_1">各フェーズでの実施内容の例</h1>
<p><img alt="" src="_attachment/image_378.png" /></p>
<ul>
<li><a href="https://github.com/awslabs/git-secrets">git-secrets</a> などでレポジトリにコミットされたシークレットをスキャン。</li>
<li>アーティファクトの S3 オブジェクトにタグ付け。</li>
<li>キーポリシーなどのセキュリティコンポーネントをデプロイ。</li>
<li>AWS Config ルールで展開されたリソースの監査。
[[
]]# セキュリティテスト</li>
</ul>
<p><img alt="" src="_attachment/image_379.png" /></p>
<p>AMI をビルドする CodePipeline のセキュリティテスト例 (SecurityTests ステージ)
- Invoke アクション (Lambda)  <code>TestAMI</code> で Amazon Inspector をトリガーして AMI をテスト
- Amazon Inspector は起動中のインスタンスをテストするので、前後にインスタンスの起動・停止を行う  Invoke アクション (Lambda) を入れている</p>
<p><img alt="" src="_attachment/image_380.png" /></p>
<p>コンテナのセキュリティテスト例</p>
<ul>
<li>Invoke アクション (Lambda) <code>TriggerClair</code> で docker コンテナの静的脆弱性スキャンツール Clair を実行。</li>
<li>Clair は各コンテナレイヤーをスキャンし、CVE および Red Hat, Ubuntu, Debian の類似データベースに基づいて脆弱性を通知する。</li>
<li><a href="https://github.com/quay/clair">https://github.com/quay/clair</a></li>
<li><a href="https://www.redhat.com/ja/topics/containers/what-is-clair">https://www.redhat.com/ja/topics/containers/what-is-clair</a></li>
</ul>
<p><img alt="" src="_attachment/image_381.png" /></p>
<ul>
<li>Python の requirements.txt のモジュールのホワイトリストチェックを CodeBuild アクションで行う例。</li>
</ul>
<hr />
<h1 id="_2">脅威検出</h1>
<p>Ref. <a href="References/AWS%20-%20Security%20-%20Governance,%20Incident%20Response.html">AWS - Security - Governance, Incident Response</a></p>
<h2 id="amazon-inspector">Amazon Inspector</h2>
<ul>
<li>起動中 EC2 インスタンス, ECS コンテナ, ECR イメージの既知の脆弱性</li>
<li>アプリケーション脆弱性診断。<ul>
<li>apt, yum などのパッケージマネージャや Windows Installer を使用してインストールされたソフトウェアを評価。</li>
</ul>
</li>
<li>ネットワーク到達性診断<ul>
<li>オープンポートの検査。不要なサーバやセキュリティグループ誤設定によって外部から到達可能なポートのチェック。</li>
</ul>
</li>
<li>ルールパッケージ<ul>
<li>CVE (共通脆弱性識別子)</li>
<li>CIS (Center for Internet Security) ... OS のセキュリティ設定ベストプラクティスのベンチマーク</li>
<li>セキュリティのベストプラクティス ... SSH root ログイン無効化, パスワード複雑性, ASR/DEP 有効化など</li>
</ul>
</li>
<li>SNS 通知により Lambda 等で自動修復。</li>
<li>エージェントレススキャン</li>
<li>SSM Agent インストール不要で24時間ごとに評価。EBSスナップショットをスキャン。</li>
<li>即時性の高いスキャン・詳細なスキャンを行いたい場合は SSM Agent インストールする。</li>
</ul>
<p><img alt="" src="_attachment/image_383.png" /></p>
<h2 id="amazon-macie">Amazon Macie</h2>
<ul>
<li>S3 内の機密データ (PII, カード番号, 認証情報)、暗号化不備、共有状況などのリスク検出。</li>
<li>S3 サーバアクセスログと CloudTrail の S3 アクセスパターンを学習およびパターンマッチング。</li>
</ul>
<p><img alt="" src="_attachment/image_384.png" /></p>
<h2 id="amazon-guardduty">Amazon GuardDuty</h2>
<ul>
<li>AWS アカウント全体の脅威検出サービス</li>
<li>VPC フローログ、DNS ログ、CloudTrail ログのイベントを分析</li>
<li>ネットワーク (VPC), インスタンス, アカウントのレベルで不正検出</li>
<li>IP レピュテーション、異常検知、機械学習などによる脅威検出</li>
<li>検出は EventBridge で通知。イベント経由で Lambda によるレスポンス自動化。</li>
</ul>
<p>検出テゴリ</p>
<ul>
<li>偵察<ul>
<li>異常な API アクティビティ</li>
<li>悪意のある既知の IP</li>
<li>ポートスキャン</li>
<li>通常とは異なるポート</li>
</ul>
</li>
<li>インスタンス侵害<ul>
<li>RDP ブルートフォース</li>
<li>異常なトラフィック量</li>
<li>ビットコインアクティビティ（暗号通貨マイニング）</li>
<li>Tor ネットワーク</li>
<li>DNS による不正抽出</li>
</ul>
</li>
<li>アカウント侵害<ul>
<li>匿名化プロキシ</li>
<li>通常とは異なるリージョンでの起動</li>
<li>CloudTrail の無効化</li>
<li>通常とは異なるインスタンスやインフラストラクチャの起動</li>
</ul>
</li>
</ul>
<h2 id="aws-security-hub">AWS Security Hub</h2>
<ul>
<li>組織カウント横断で各種セキュリティサービスの検出結果を統合・優先順位づけしてダッシュボード表示。</li>
<li>自動のコンプライアンススキャン: AWS ベストプラクティスや CIS, PCI-DSS, AWS Config のコンフォーマンスパックのコンプライアンスチェックを継続的に実施。</li>
<li>CloudWatch Events 通知とレスポンス自動化</li>
</ul>
<p><img alt="" src="_attachment/image_386.png" /></p>
<hr />
<h1 id="configuration-management">Configuration Management/構成管理</h1>
<p>インフラストラクチャ、システム、製品の構成要素、設計に関する詳細、構築状態を、追跡・記録し、必要なときにアクセスできるようにする。</p>
<p><img alt="" src="_attachment/image_387.png" /></p>
<ul>
<li>インフラは CloudFormation で構築・管理。</li>
<li>インスタンス上へのデプロイは cfn-init を UserData に設定することで構築できる。</li>
<li>Systems Manager やサードパーティーツールでもデプロイ・設定できる。</li>
<li>サードパーティーツール: Chef, Puppet, Ansible, Salt</li>
</ul>
<h2 id="aws-config">AWS Config</h2>
<p>Ref. <a href="AWS/AWS%20Security%20Governance,%20Incident%20Response.html">AWS: Security: Governance, Incident Response</a></p>
<p>AWS Config
- AWS リソース構成のスナップショット保存と変更履歴の管理
    - スナップショットと変更履歴を S3 バケットに保存
    - 変更発生時の EventBridge/SNS 通知 (オプショナル)
    - 構成変更の差分確認
AWS Config ルール
- リソース設定のコンプライアンス状態の管理
- AWS Config で取得したリソース設定が Lambda 関数に送られてルール評価が実施される
    - リソースが対象なのでインスタンス内のアプリケーションなどはカバーされない。
- マネージドルール
    - iam-user-mfa-enabled ... MFAが有効？
    - encrypted-volumes ... アタッチされたEBSが暗号化されている？
    - TrustedAdvisor も一部のルールを同様に検出ができるが即時性や修復アクションの有無が大きな違い
- カスタムルール (ユーザが Lambda で実装)
- <strong>修復アクション</strong>:
  - Config ルールに対する Noncompliant が発生した際に実行する SSM Automation アクションを設定できる
  - 例: EC2 インスタンスの停止等
AWS Config アグリゲーター
  - 中央アカウントにアグリゲーターを作成、マルチアカウント/マルチリージョンの AWS Config 情報を集約</p>
<h2 id="aws-service-catalog">AWS Service Catalog</h2>
<p>Ref. <a href="AWS/AWS%20Security%20CloudFormation,%20Service%20Catalog,%20Control%20Tower.html">AWS: Security: CloudFormation, Service Catalog, Control Tower</a></p>
<p>管理者が提供する CloudFormation テンプレート(=製品)を指定された IAM ロールとパラメータ(=制約)で、エンドユーザが自身でプロビジョンする仕組み。</p>
<p><strong>管理者タスク</strong></p>
<ul>
<li><strong>Product (製品) 作成</strong><ul>
<li>実体は CloudFormation テンプレート。</li>
<li>バージョン管理が可能。</li>
</ul>
</li>
<li><strong>Portfolio (ポートフォリオ) 作成</strong><ul>
<li>製品の集合体（コレクション）</li>
<li>特定ユーザー、グループ、ロールに公開する管理単位。</li>
</ul>
</li>
<li><strong>Control (制約)</strong><ul>
<li><strong>テンプレート制約</strong>:  CloudFormation テンプレートのパラメータを制限。</li>
<li><strong>起動制約</strong>:  製品からリソースをプロビジョニングする際に使用するロールを指定。 ユーザに CloudFormation の直接権限を与えず、Catalog 経由でのみリソース作成を許可する。</li>
</ul>
</li>
</ul>
<p><strong>ユーザータスク</strong></p>
<ul>
<li><strong>Product List (製品リスト) からの製品の選択</strong><ul>
<li>IAM によって認可された、自身が利用可能な製品の一覧。</li>
</ul>
</li>
<li><strong>Launch (起動)</strong><ul>
<li>リストから製品を選択し、パラメータを入力してデプロイ。</li>
</ul>
</li>
<li><strong>Provisioned Products</strong><ul>
<li>起動された CloudFormation スタックの実体。</li>
</ul>
</li>
</ul>
<h2 id="compliance-as-code">Compliance-as-Code</h2>
<ul>
<li>コンプライアンス要件を AWS Config ルールのカスタムコードとして Lambda のコードとして定義。</li>
<li>Service Catalog で製品をユーザに提供。展開された製品の CloudFormation スタックに対して AWS Config ルールによる監査を実行。</li>
<li>AWS Config ルールの修復アクションとしてとして SSM Automation でドキュメント実行もできる。</li>
</ul>
<p><img alt="" src="_attachment/image_391.png" /></p>
<p><a href="https://aws.amazon.com/jp/blogs/apn/how-to-automate-cloud-governance-to-achieve-safety-at-speed/">https://aws.amazon.com/jp/blogs/apn/how-to-automate-cloud-governance-to-achieve-safety-at-speed/</a></p>
<hr />
<h1 id="ami">カスタム AMI</h1>
<h2 id="ami_1">AMI の構成要素</h2>
<ul>
<li>ルートボリュームのテンプレート (OS, アプリケーションなどを含む)</li>
<li>起動許可: どのアカウントでその AMI からインスタンス実行できるかを管理する</li>
<li>ブロックデバイスマッピング: インスタンス作成時にアタッチするボリュームを指定する</li>
<li>ルートデバイス用ストレージ種類: EBS の Snapshot-Backed または Instance Store-Backed</li>
<li>AMI はリージョンリソースで、リージョンに登録する。</li>
</ul>
<h2 id="ami_2">ゴールデン AMI</h2>
<ul>
<li>サーバのイメージをテンプレート化する事によって、デプロイ時間の短縮や再現性を高める</li>
<li>カスタムしたソフトウェアや設定を事前にインストール・定義しておける</li>
<li>最新のセキュリティパッチなど適用するため、AMI 構築は自動化する。</li>
</ul>
<p><img alt="" src="_attachment/image_392.png" /></p>
<ul>
<li>完全ビルド<ul>
<li>全てを含む AMI</li>
<li>デプロイが簡単で起動時間が高速</li>
</ul>
</li>
<li>JeOS (Just Enough Operating System)<ul>
<li>最小限の OS と構成管理エージェントのみを含み、残りは起動時にインストール</li>
<li>柔軟性とポータビリティ</li>
</ul>
</li>
<li>ハイブリッド<ul>
<li>完全ビルドと JeOS との中間</li>
<li>動的な変更の柔軟性と、起動速度を両立</li>
</ul>
</li>
</ul>
<p><img alt="" src="_attachment/image_393.png" /></p>
<ul>
<li>検証や承認のフローがある。</li>
<li>自動化は SSM Automation, CodePipline/CodeBuid や EC2 Image Builder で実装。</li>
</ul>
<p>CI/CD パイプラインの中でゴールデン AMI を利用する例:</p>
<p><img alt="" src="_attachment/image_394.png" /></p>
<ul>
<li>CodePipline 中の Lambda ステップによって SSM Automation を実行してゴールデン AMI をビルドしている。</li>
</ul>
<p>AMI 構築の SSM Automation ドキュメント (Runbook):</p>
<p>AWS-UpdateLinuxAmi</p>
<ul>
<li>Amazon Linux、Red Hat、Ubuntu、CentOS AMI のディストリ ビューションパッケージおよび Amazon ソフトウェアをすべてアップ グレードします。</li>
</ul>
<p>AWS-UpdateWindowsAmi</p>
<ul>
<li>Windows アップデートをすべてインストールし、Amazon ソフト ウェアをアップグレードします</li>
</ul>
<p>Automation Runbook で Golden AMI 作成・検証・登録などの一連のプロセスを全て行う例:</p>
<p><img alt="" src="_attachment/image_395.png" /></p>
<p>Ref. <a href="https://d1.awsstatic.com/whitepapers/aws-building-ami-factory-process-using-ec2-ssm-marketplace-and-service-catalog.pdf">https://d1.awsstatic.com/whitepapers/aws-building-ami-factory-process-using-ec2-ssm-marketplace-and-service-catalog.pdf</a></p>
<h2 id="ec2-image-builder">EC2 Image Builder</h2>
<p>AWS,オンプレミス両方で使えるゴールデンイメージを作成できる。</p>
<p><img alt="" src="_attachment/image_396.png" /></p>
<ul>
<li>Windows と Linux に対応。</li>
<li>コード不要で GUI で自動化パイプラインを生成。</li>
<li>AWS 提供の設定やカスタム設定でイメージのセキュリティ保護。</li>
<li>AWS 提供のテストやカスタムテストを使用してイメージ をテスト。</li>
<li>ソフトウェアの更新がある度に、自動でパイプラインが実行される。<ul>
<li>ソフトウェアや設定をカスタマイズ</li>
<li>テンプレートを使用してセキュアなイメージにする</li>
<li>イメージのテストを行う</li>
<li>選択したリージョン(複数可)にゴールデンイメージを配布する</li>
</ul>
</li>
</ul>
<p><img alt="" src="_attachment/image_397.png" /></p>
</article>

    </main>
    <footer class="footer" role="contentinfo">
        <span class="footer__title" id="title">AWS - DevSecOps, Configuration Management</span>
        <span class="footer__percentage" aria-live="polite"><span id="scrollPercentage">0%</span></span>
    </footer>
    <script src="static/script.js"></script>
</body>
</html>