<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>AWS - Security - KMS, Secrets Manager, ACM - AWS DevOps Notes</title>
    <link rel="stylesheet" href="static/style.css">
</head>
<body>
    
    <header>
        <h1>AWS - Security - KMS, Secrets Manager, ACM</h1>
    </header>
    
    <main>
        
<article>
    <h1 id="aws-kms">AWS KMS</h1>
<p>Ref.</p>
<ul>
<li><a href="https://docs.aws.amazon.com/kms/latest/developerguide/concepts.html">https://docs.aws.amazon.com/kms/latest/developerguide/concepts.html</a></li>
<li><a href="https://d1.awsstatic.com/webinars/jp/pdf/services/20181121_AWS-BlackBelt-KMS.pdf">https://d1.awsstatic.com/webinars/jp/pdf/services/20181121_AWS-BlackBelt-KMS.pdf</a></li>
<li><a href="https://docs.aws.amazon.com/kms/latest/APIReference/API_Operations.html">https://docs.aws.amazon.com/kms/latest/APIReference/API_Operations.html</a></li>
</ul>
<p>概要</p>
<ul>
<li>暗号化に使うデータキーを暗号化するマスターキーを管理するサービス。</li>
<li>
<p>CMK: Customer Master Key</p>
<ul>
<li>KMS 内の HSM で暗号化された状態で保管されるマスターキー。</li>
<li>対象鍵 (AES256), 非対称鍵 (RSA, ECC) がサポートされている。</li>
<li>キーローテーションがある。</li>
</ul>
</li>
<li>
<p>CDK: Customer Data Key</p>
<ul>
<li>データの暗号化に使用するキー。使用時以外は CMK で暗号化されたものを保存。</li>
<li>対象データキーと非対称データキーペアがある。<ul>
<li>非対称なら公開鍵をアプリに保存して暗号化時に使用、復号時のみ秘密鍵を Decrypt して復号という使い方もできる。</li>
<li>非対称は署名用途にも使える。</li>
<li>Ref. <a href="https://docs.aws.amazon.com/ja_jp/kms/latest/developerguide/concepts.html#data-key-pairs">データキーペア</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img alt="" src="_attachment/image_1431.png" /></p>
<p>エンベロープ暗号化</p>
<ul>
<li>鍵を鍵で暗号化することを指す。多重にかける場合は頂点のキーをルートキーと呼ぶ。</li>
<li><img alt="" src="_attachment/image_1432.png" /></li>
</ul>
<p><img alt="" src="_attachment/image_1433.png" /></p>
<p>CreateKey
- CMK を生成。KeyID が返り CMK そのものは返らない。</p>
<p>GenerateDataKey/GenerateDataKeyPair
- KeyID を指定してデータキーを生成。データキーとして Plaintext と CiphertextBlob が返る。</p>
<pre><code>{
    &quot;CiphertextBlob&quot;: &quot;blob&quot;,
    &quot;KeyId&quot;: &quot;string&quot;,
    &quot;Plaintext&quot;: &quot;blob&quot;
}
</code></pre>
<p>暗号化の手順
- GenerateDataKey で平文データキー (Plaintext) で暗号化し、暗号化したデータを暗号化データキー (CiphertextBlob) とともに保管。
- 平文データキーは廃棄。</p>
<p>復号の手順
- Decrypt で暗号化 データキーを復号し、暗号化データを復号。</p>
<p><a href="https://docs.aws.amazon.com/ja_jp/kms/latest/APIReference/API_Encrypt.html">Encrypt</a>
- GenerateDataKey で暗号化データキーが得られるので通常は使用しない。
- CMK の KeyId を指定して最大 4KB までの任意のデータを暗号化できる。
- Ciphertext には CMK の情報と暗号化されたデータが含まれる。Decrypt 時は KeyId 指定不要。
- Usecase-1:  DB パスワードなどサイズの小さなシークレットを暗号化する場合。
- Usecase-2: データキーをクロスリージョンで共有するために、データキーを別リージョンの CMK で暗号化して渡す。<br></p>
<p>AWS Encryption SDK
- 暗号化すると Encrypted message というバイナリ形式でアウトプットされる。
- 暗号文とともに暗号化されたデータキーやアルゴリズムなどのメタデータを含む。<br></p>
<p>AWS サービス統合</p>
<ul>
<li>サービスによってサポートする CMK の種類は異なる。</li>
<li>
<p>カスタマー管理キー (Customer managed CMKs)</p>
<ul>
<li>カスタマーが作成し、フルコントロールで管理・使用できる通常の CMK。</li>
<li>カスタマーの AWS アカウントで所有される。月1ドル。</li>
</ul>
</li>
<li>
<p>AWS 管理キー (AWS managed CMKs)</p>
<ul>
<li>AWS 各サービスで使用するために自動的に作成される CMK。</li>
<li>カスタマーの AWS アカウントで所有される。キー所有は無料。</li>
<li>CloudTrail で鍵利用を監査可能。</li>
<li>キーポリシーが変更できず、削除やローテーション、クロスアカウントでの使用、Encrypt/Decrypt ができない。</li>
</ul>
</li>
<li>
<p>AWS 所有キー (AWS owned CMKs)</p>
<ul>
<li>AWS サービスにより所有される CMK。</li>
<li>S3 のデフォルトとかで使われる。</li>
</ul>
</li>
<li>
<p>Ref. <a href="https://docs.aws.amazon.com/ja_jp/kms/latest/developerguide/concepts.html#kms_keys">https://docs.aws.amazon.com/ja_jp/kms/latest/developerguide/concepts.html#kms_keys</a></p>
</li>
</ul>
<p>エイリアス</p>
<ul>
<li>リージョンごとにユニークなキーの別名。</li>
<li>管理コンソールで CMK を作成する際には必須。</li>
<li>エイリアスがないと統合サービスで CMK を選択する際に面倒。手動ローテーションにも必要。</li>
</ul>
<p>キーポリシー</p>
<ul>
<li>CMK のリソースベースポリシー。</li>
<li>管理コンソールで作る際は管理者向けポリシー、利用者向けポリシーを適用するプリンシパルを選択する。</li>
</ul>
<p><img alt="" src="_attachment/image_1434.png" /><img alt="" src="_attachment/image_1435.png" /></p>
<p>S3 の SSE-KMS で作成した AWS 管理キーのキーポリシー例:</p>
<pre><code>{
    &quot;Version&quot;: &quot;2012-10-17&quot;,
    &quot;Id&quot;: &quot;auto-s3-2&quot;,
    &quot;Statement&quot;: [
        {
            &quot;Sid&quot;: &quot;Allow access through S3 for all principals in the account that are authorized to use S3&quot;,
            &quot;Effect&quot;: &quot;Allow&quot;,
            &quot;Principal&quot;: {
                &quot;AWS&quot;: &quot;*&quot;
            },
            &quot;Action&quot;: [
                &quot;kms:Encrypt&quot;,
                &quot;kms:Decrypt&quot;,
                &quot;kms:ReEncrypt*&quot;,
                &quot;kms:GenerateDataKey*&quot;,
                &quot;kms:DescribeKey&quot;
            ],
            &quot;Resource&quot;: &quot;*&quot;,
            &quot;Condition&quot;: {
                &quot;StringEquals&quot;: {
                    &quot;kms:ViaService&quot;: &quot;s3.us-west-2.amazonaws.com&quot;,
                    &quot;kms:CallerAccount&quot;: &quot;123456789000&quot;
                }
            }
        },
        {
            &quot;Sid&quot;: &quot;Allow direct access to key metadata to the account&quot;,
            &quot;Effect&quot;: &quot;Allow&quot;,
            &quot;Principal&quot;: {
                &quot;AWS&quot;: &quot;arn:aws:iam::123456789000:root&quot;
            },
            &quot;Action&quot;: [
                &quot;kms:Describe*&quot;,
                &quot;kms:Get*&quot;,
                &quot;kms:List*&quot;
            ],
            &quot;Resource&quot;: &quot;*&quot;
        }
    ]
}
</code></pre>
<p>許可 (Grants)</p>
<ul>
<li>ポリシーを変更せずに他のプリンシパルに Decrypt/Encrypt などの特定アクションの許可を一時的に与える。プログラムで動的に権限を許可したい場合などに使える。</li>
<li><img alt="" src="_attachment/image_1436.png" /></li>
<li><a href="https://docs.aws.amazon.com/kms/latest/APIReference/API_CreateGrant.html">CreateGrant</a> のパラメータ:</li>
<li><img alt="" src="_attachment/image_1437.png" /></li>
<li>RetiringPrincipal は <a href="https://docs.aws.amazon.com/kms/latest/APIReference/API_RetireGrant.html">RetireGrant</a> で Grant を削除できるプリンシパルを指定する。</li>
<li>もともと権限のあるプリンシパルは <a href="https://docs.aws.amazon.com/kms/latest/APIReference/API_RevokeGrant.html">RevokeGrant</a> で Grant を削除する。</li>
<li>Grant token: Grants は Eventual Consistency (結果整合性) で作成されるため即時有効にならないが、各 API に Grant token を指定することで即時に利用できる。</li>
<li>Ref. <a href="https://docs.aws.amazon.com/kms/latest/developerguide/grants.html">https://docs.aws.amazon.com/kms/latest/developerguide/grants.html</a></li>
</ul>
<p>Encryption Context</p>
<ul>
<li>対称鍵での Encrypt/GenerateDataKey 時に指定できる Key/Value ペアの追加認証情報。</li>
<li><img alt="" src="_attachment/image_1438.png" /></li>
</ul>
<p>CreateGrant の Constraints はこの2つしかサポートしていない</p>
<ul>
<li>EncryptionContextEquals: 全く同じ Key/Value の配列を指定する必要がある</li>
<li>EncryptionContextSubset: Key/Value 配列に余計な値が入っても OK</li>
<li><img alt="" src="_attachment/image_1439.png" /></li>
<li><a href="https://docs.aws.amazon.com/kms/latest/developerguide/create-grant-overview.html#grant-constraints">https://docs.aws.amazon.com/kms/latest/developerguide/create-grant-overview.html#grant-constraints</a></li>
</ul>
<p>CMK の削除と無効化</p>
<ul>
<li><a href="https://docs.aws.amazon.com/kms/latest/APIReference/API_ScheduleKeyDeletion.html">ScheduleKeyDeletion</a> で削除。最短7日、デフォルト30日かかる。</li>
<li>
<p>単に利用停止したい場合は <a href="https://docs.aws.amazon.com/kms/latest/APIReference/API_DisableKey.html">DisableKey</a> で無効化する。</p>
<ul>
<li>復号が完全に不可能になるので削除は推奨されないっぽい。</li>
</ul>
</li>
<li>
<p>削除がスケジュールされた CMK での API は KMSInvalidStateException になり使用できない。</p>
</li>
</ul>
<p>CMK のローテーション</p>
<p><img alt="" src="_attachment/image_1440.png" /></p>
<ul>
<li>
<p>HSM Backing Key (HBK)</p>
<ul>
<li>CMK の実体となる平文の鍵。キーマテリアル。</li>
<li>CMK 生成時に HSM で生成、もしくは BYOK でインポート。</li>
<li>HSM の揮発性メモリ上でのみ平文で存在。平文のまま HSM から取り出し不可。</li>
</ul>
</li>
<li>
<p>古いキーマテリアルも永続的に保持されて Decrypt 時に自動的にバージョンが選択される。</p>
</li>
<li>自動ローテーション<ul>
<li>カスタマー管理キーで1年の自動ローテーションを有効にする (<a href="https://docs.aws.amazon.com/kms/latest/APIReference/API_EnableKeyRotation.html">EnableKeyRotation</a>)</li>
<li>カスタマー管理キーのローテーションはデフォルト無効、AWS 管理キーは 3 年。</li>
<li>非対称 CMK, インポートしたキー, カスタムキーストアは自動ローテション不可。</li>
</ul>
</li>
</ul>
<p>手動ローテーション</p>
<ul>
<li>新しい CMK に手動で置き換えること。</li>
<li>1年より短期間でのキーマテリアル更新や自動ローテーション不可のキーのために実施。</li>
<li>
<p>キーID/ARN が変わるのでアプリケーション側はエイリアスを使用する。</p>
<ul>
<li><a href="https://docs.aws.amazon.com/kms/latest/APIReference/API_UpdateAlias.html">UpdateAlias</a> でキー ID を付け替える。</li>
</ul>
</li>
<li>
<p>これを定期的に自動化するには EventBridge で Lambda のスケジュール実行などが必要。</p>
</li>
<li>手動ローテーション後に古い CMK を削除すると既存データが復号できなくなることに注意。</li>
<li>
<p><a href="https://docs.aws.amazon.com/kms/latest/APIReference/API_ReEncrypt.html">ReEncrypt</a>: いったん Decrypt して再度 Encrypt する操作を一度に行う。</p>
<ul>
<li>手動ローテーション後にデータキーを新しい CMK で暗号化しなおすのに使える。</li>
<li>または同じ CMK で Encryption Context を変更する操作に利用できる。</li>
</ul>
</li>
<li>
<p><a href="https://docs.aws.amazon.com/kms/latest/developerguide/rotate-keys.html#rotate-keys-manually">https://docs.aws.amazon.com/kms/latest/developerguide/rotate-keys.html#rotate-keys-manually</a></p>
</li>
</ul>
<p>キーのインポート (BYOK: Bring Your Own Keys)</p>
<ul>
<li>256 bit 対称鍵 (キーマテリアル) をインポートできる。</li>
<li>
<p>有効期限があるが自動ローテーションは不可。</p>
<ul>
<li>つまりキーマテリアルの再インポートはできず、新しい CMK への変更が必要。</li>
</ul>
</li>
<li>
<p><a href="https://docs.aws.amazon.com/ja_jp/kms/latest/developerguide/importing-keys-delete-key-material.html">インポートされたキーマテリアルの削除</a>ができる</p>
<ul>
<li>同じキーマテリアルの再インポートはできるが異なるものは不可。</li>
<li>再インポート時でもラッピングキーとインポートトークンは新しいものを使う。</li>
</ul>
</li>
</ul>
<p><img alt="" src="_attachment/image_1441.png" /></p>
<ul>
<li>Ref. <a href="https://aws.amazon.com/jp/blogs/news/new-bring-your-own-keys-with-aws-key-management-service/">https://aws.amazon.com/jp/blogs/news/new-bring-your-own-keys-with-aws-key-management-service/</a></li>
<li>Wrapping key と import token というものを使用する</li>
<li><img alt="" src="_attachment/image_1442.png" /></li>
<li>ランダムな 256-bit 鍵を生成して Wrapping key で暗号化</li>
</ul>
<pre><code>$ openssl rand -out plain_text_aes_key.bin 32
$ openssl rsautl -encrypt -in plain_text_aes_key.bin -oaep \
-inkey wrappingKey_fcb572d3-6680-449c-91ab-ac3a5c07dc09_0804104355 \
-pubin -keyform DER -out enc.aes.key
</code></pre>
<ul>
<li><img alt="" src="_attachment/image_1443.png" /></li>
</ul>
<p>カスタムキーストア</p>
<ul>
<li>自前で VPC 内に立てる CloudHSM クラスターで CMK を保持。</li>
<li>
<p>コンプライアンスでキーストアに次のような要件が必要な場合:</p>
<ul>
<li>キーマテリアルを共有環境に保存できない (シングルテナントが必要)</li>
<li>複数リージョンにキーマテリアルをバックアップする必要がある</li>
<li>キーマテリアルを KMS とは別に監査可能にしておく必要がある</li>
<li>HSM が FIPS 140-2 レベル 3 認定される必要がある</li>
</ul>
</li>
<li>
<p><a href="https://docs.aws.amazon.com/ja_jp/kms/latest/developerguide/custom-key-store-overview.html">https://docs.aws.amazon.com/ja_jp/kms/latest/developerguide/custom-key-store-overview.html</a></p>
</li>
</ul>
<p><img alt="" src="_attachment/image_1444.png" /></p>
<p>マルチリージョンキー (2021/6~)</p>
<ul>
<li>CMK 作成時にマルチリージョンキーを指定すると他のリージョンにレプリケートできる。</li>
<li>同じ Key ID とキーマテリアルがレプリケートされるので暗号化データキーがクロスリージョンで利用できる。</li>
<li>ローテーションの際も自動でレプリケートされる。</li>
<li><img alt="" src="_attachment/image_1445.png" /></li>
<li><a href="https://docs.aws.amazon.com/kms/latest/developerguide/multi-region-keys-overview.html">https://docs.aws.amazon.com/kms/latest/developerguide/multi-region-keys-overview.html</a></li>
</ul>
<p>EBS の SSE-KMS</p>
<ul>
<li>暗号化されたデータキーがボリュームメタデータに保存される。</li>
<li>インスタンスはデータキーを Decrypt してボリュームの暗号化・復号に使用する。</li>
</ul>
<p><img alt="" src="_attachment/image_1446.png" /></p>
<ul>
<li>Grant を作成するために IAM ユーザのポリシーに次のような許可が必要。</li>
</ul>
<pre><code>&quot;Effect&quot;: &quot;Allow&quot;,
&quot;Action&quot;: {
  &quot;kms:CreateGrant&quot;
},
&quot;Resource&quot;: {
  &quot;arn:aws:kms:us-east-1:012345678910:key/ebs-encryption-key&quot;
},
&quot;Condition&quot;: {
  &quot;StringEquals&quot;: {
    &quot;kms:ViaService&quot;: &quot;ec2.us-west-2.amazonaws.com&quot;,
  }
}
</code></pre>
<p>これもそう？</p>
<p><img alt="" src="_attachment/image_1447.png" /></p>
<p>AMI (ブートボリューム) の KMS 暗号化</p>
<ul>
<li>AMI も EBS スナップショットベースなので同様の仕組み。</li>
<li>Auto Scaling グループの Service-linked ロールで CreateGrant を許可して暗号化された AMI を展開できるようにするという問題があった。</li>
</ul>
<p>EC2 Auto Scaling で KMS のカスタマー管理キーで暗号化された AMI/EBS のインスタンスを起動する方法</p>
<p><a href="https://aws.amazon.com/premiumsupport/knowledge-center/kms-launch-ec2-instance/">https://aws.amazon.com/premiumsupport/knowledge-center/kms-launch-ec2-instance/</a></p>
<p>Auto Scaling の Service-linked Role (SLR) に暗号化・復号を行う API を実行する grant を作成する。</p>
<p>クロスアカウントの例:</p>
<p>キーポリシーでリモートアカウントに暗号化・復号系 API と CreateGrant の許可を委譲</p>
<pre><code>    &quot;Effect&quot;: &quot;Allow&quot;,
    &quot;Principal&quot;: { &quot;AWS&quot;: &quot;arn:aws:iam::111122223333:root&quot; },
    &quot;Action&quot;: [
        &quot;kms:Encrypt&quot;,
        &quot;kms:Decrypt&quot;,
        &quot;kms:ReEncrypt*&quot;,
        &quot;kms:GenerateDataKey*&quot;,
        &quot;kms:DescribeKey&quot;
    ],
---
    &quot;Effect&quot;: &quot;Allow&quot;,
    &quot;Principal&quot;: { &quot;AWS&quot;: &quot;arn:aws:iam::111122223333:root&quot; },
    &quot;Action&quot;: [
        &quot;kms:CreateGrant&quot;
    ],
</code></pre>
<p>リモートアカウント側で Auto Scaling の SLR に次の grant を作成する</p>
<pre><code>$ REMOTE_KEYID=&quot;arn:aws:kms:us-west-2:444455556666:key/1a2b3c4d-5e6f-1a2b-3c4d-5e6f1a2b3c4d&quot;
$ AUTOSCALING_SLR=&quot;arn:aws:iam::111122223333:role/aws-service-role/autoscaling.amazonaws.com/AWSServiceRoleForAutoScaling&quot;
$ aws kms create-grant --key-id ${REMOTE_KEYID} --grantee-principal ${AUTOSCALING_SLR} \
  --operations Decrypt GenerateDataKeyWithoutPlaintext ReEncryptFrom ReEncryptTo CreateGrant
</code></pre>
<ul>
<li>CreateGrant は EC2 に Decrypt を許可する grant を作成するため。</li>
<li>GenerateDataKeyWithoutPlaintext はボリュームメタデータに渡すキーを作成するため？</li>
</ul>
<h1 id="_1">各種サービスの暗号化</h1>
<h2 id="_2">デフォルトで暗号化されるデータ</h2>
<p>DynamoDB</p>
<ul>
<li>デフォルトで AWS owned CMK で暗号化される。</li>
</ul>
<p>Lambda 環境変数</p>
<ul>
<li>デフォルトで AWS managed CMK で暗号化される。</li>
</ul>
<p>AWS Secrets Manager</p>
<ul>
<li>シークレットはデフォルトで AWS managed CMK で暗号化される。</li>
</ul>
<p>CloudTrail 証跡</p>
<ul>
<li>デフォルトで AWS 管理キーによる SSE-KMS が有効化される。</li>
</ul>
<p>CodeCommit</p>
<ul>
<li>KMS で暗号化されている。</li>
</ul>
<p>CodeBuild アーティファクト</p>
<ul>
<li>デフォルトで SSE-KMS の AWS managed CMK で暗号化される。</li>
<li>Customer managed CMK も指定できる。</li>
</ul>
<p>Storage Gateway</p>
<ul>
<li>デフォルトで SSE-S3 有効。API で SSE-KMS も利用できる。</li>
</ul>
<h2 id="_3">オプショナル</h2>
<p>S3</p>
<ul>
<li>デフォルトでは暗号化されない。</li>
<li>SSE-S3, SSE-KMS をバケットに指定。</li>
</ul>
<p>RDS</p>
<ul>
<li>DB 作成時に KMS での暗号化を設定できる。</li>
</ul>
<p>AWS Systems Manager Parameter Store</p>
<ul>
<li>KMS で暗号化されたパラメータ (SecureString)。</li>
<li>デフォルトの AWS managed CMK か、自前の Customer managed CMK を使用。</li>
</ul>
<p>SQS/SNS</p>
<ul>
<li>Customer managed/AWS managed CMK による SSE-KMS が可能 (デフォルト OFF)。 </li>
<li>属性は暗号化の対象外。</li>
</ul>
<p>CloudWatch Logs</p>
<ul>
<li>オプションで KMS 暗号化もできる。</li>
</ul>
<p>Kinesis Data Streams</p>
<ul>
<li>
<p>シャードに保存されるデータの KMS によるサーバサイド暗号化をサポート。</p>
<ul>
<li>AWS owned (?) と Customer managed の CMK</li>
</ul>
</li>
<li>
<p>転送中のデータについては HTTPS エンドポイントを使用する。</p>
</li>
</ul>
<p>ElastiCache for Redis</p>
<ul>
<li>カスタマー管理キーで保管時の暗号化をサポート。</li>
<li>ElastiCache for Memcached は保管時の暗号化をサポートしない。</li>
</ul>
<p>EBS, EFS</p>
<p><img alt="" src="_attachment/image_1448.png" /></p>
<p>Ref. <a href="AWS/Security%20Engineering%20on%20AWS%20Lab5%20AWS%20KMS%20%E3%81%AE%E4%BD%BF%E7%94%A8.html">Security Engineering on AWS: Lab5 AWS KMS の使用</a></p>
<ol>
<li>
<p>管理コンソールで CMK を作成</p>
<ul>
<li>作成時にエイリアスを指定、さらにキー管理者とキーユーザーのプリンシパルを指定。</li>
<li>作成後、管理コンソールでキーローテーションを有効にする。</li>
</ul>
</li>
<li>
<p>暗号化 EBS ボリュームの作成</p>
<ul>
<li>暗号化の設定でさきほど作成した CMK のエイリアスを指定する。</li>
</ul>
</li>
<li>
<p>ブートボリュームの暗号化</p>
<ul>
<li>インスタンスを停止して AMI を作成。</li>
<li>さらに AMI をコピーする。その際に「ターゲット EBS スナップショットの暗号化」を有効化、作成した CMK のエイリアスを指定する。</li>
<li><img alt="" src="_attachment/image_1449.png" /></li>
</ul>
</li>
<li>
<p>S3 バケットに SSE-KMS を設定</p>
<ul>
<li>CMK をコンソールで無効化した後にオブジェクトを開くと DisabledException エラー。</li>
</ul>
</li>
<li>
<p>S3 バケットにさらにクロスリージョンレプリケーションを設定</p>
<ul>
<li>レプリケーション設定以前に追加されていたオブジェクトはレプリケーションされない。</li>
<li>バケット指定した SSE-KMS のカスタマー管理キーで 暗号化されたオブジェクトはリモートリージョンの AWS 管理キーで SSE-KMS 暗号化されてレプリケーションされた。</li>
<li>オブジェクトアップロード時に SSE-S3 で上書きしたオブジェクトはリモートリージョンでも SSE-S3 でレプリケーションされる。</li>
</ul>
</li>
<li>
<p><img alt="" src="_attachment/image_1450.png" /></p>
</li>
</ol>
<p>Ref. S3 クロスリージョンレプリケーションの説明</p>
<p><a href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/replication-what-is-isnot-replicated.html">https://docs.aws.amazon.com/AmazonS3/latest/userguide/replication-what-is-isnot-replicated.html</a></p>
<hr />
<h1 id="aws-cloudhsm">AWS CloudHSM</h1>
<p>概要</p>
<ul>
<li>VPC 内に立てる HSM (HW Security Module)。コンプラ要件のために必要な場合など。</li>
<li>可用性担保のためクラスター構成となる。</li>
<li>アプリからは PKCS#11、Java Cryptography Extensions (JCE)、Microsoft CryptoNG (CNG) ライブラリといった業界標準の API を使用して利用</li>
</ul>
<p><img alt="" src="_attachment/image_1451.png" /></p>
<ul>
<li>AWS 予約済の 4 個は障害を起こした HSM インスタンスの交換などの内部使用。</li>
<li>キーは「エクスポート不可」として生成されていない限り、クラスター外にエクスポート (またはラップ) し、オンプレミスでバックアップできる。</li>
<li>AWS は HSM アプライアンスの管理とモニタリングを行うがキーにはアクセスできず、AWS でキーマテリアルを回復させることはできない。</li>
</ul>
<hr />
<h1 id="aws-secrets-manager">AWS Secrets Manager</h1>
<p>概要・特徴</p>
<ul>
<li>アプリへのキーの埋め込み問題の解決。</li>
<li>DB 認証情報、API キー、その他シークレットの管理とローテーション。</li>
<li>RDS, Aurora に統合してシークレットのローテーションが可能。</li>
<li>ステークホルダーが一切キーを知らずに利用できる。</li>
<li>監査ログ</li>
</ul>
<p>キーの取得</p>
<ul>
<li>アプリから <a href="https://docs.aws.amazon.com/secretsmanager/latest/apireference/API_GetSecretValue.html">GetSecretValue</a> でシークレットを取得して DB や API にアクセスする。</li>
<li>ASM に登録したシークレットの ARN を環境変数などでアプリに渡しておく。</li>
<li><img alt="" src="_attachment/image_1452.png" /></li>
</ul>
<p>ローテーション</p>
<ul>
<li>
<p>Aurora や RDS についてはあらかじめ Lambda 関数が用意されている。</p>
<ul>
<li>その他の場合はカスタム Lambda 関数を使用する。</li>
<li>ローテーション後に認証エラーになったらアプリケーション側で <a href="https://docs.aws.amazon.com/ja_jp/secretsmanager/latest/apireference/API_GetSecretValue.html">GetSecretValue</a>  API で認証情報を取りに行ってもよい</li>
</ul>
</li>
<li>
<p>ローテーションを設定した直後に最初のローテーションが行われる。</p>
</li>
</ul>
<p><img alt="" src="_attachment/image_1453.png" /></p>
<p>シークレットは KMS で暗号化される</p>
<ul>
<li>デフォルトの AWS managed CMK か、自前の Customer managed CMK を使用。</li>
<li><a href="https://docs.aws.amazon.com/ja_jp/kms/latest/developerguide/services-secrets-manager.html">https://docs.aws.amazon.com/ja_jp/kms/latest/developerguide/services-secrets-manager.html</a></li>
</ul>
<hr />
<h1 id="aws-systems-manager-parameter-store">AWS Systems Manager Parameter Store</h1>
<ul>
<li>アプリのシークレットの外部保管。</li>
<li>
<p>KMS で暗号化されたパラメータを利用できる (SecureString 型)。</p>
<ul>
<li>AWS 管理キー(デフォルト) かカスタマー管理キーを使用。</li>
</ul>
</li>
<li>
<p>Standard tier で使用する場合は無料。</p>
</li>
<li><img alt="" src="_attachment/image_1454.png" /></li>
<li>パラメータ数はけっこう多く持てるがアクセスのスループット上限 (TPS) もある。</li>
</ul>
<p><img alt="" src="_attachment/image_1455.png" /></p>
<p>Secrets Manager の利点</p>
<ul>
<li>CloudFormation でランダムなシークレットを生成できる。</li>
<li>ローテーション可能。</li>
</ul>
<p>Parameter Store を取得するポリシー</p>
<ul>
<li>インスタンス等から SecureString を使用するには次のような2種類のポリシーが必要。</li>
<li>つまりパラメータは暗号化されてまま取得されてローカルで復号される。</li>
</ul>
<pre><code>&quot;Effect&quot;:&quot;Allow&quot;,
&quot;Action&quot;:&quot;ssm:GetParameters&quot;
&quot;Resource&quot;:&quot;arn:aws:ssm:region:account-id:parameter/prod-*&quot;

&quot;Effect&quot;:&quot;Allow&quot;,
&quot;Action&quot;:&quot;kms:Decrypt&quot;
&quot;Resource&quot;:&quot;arn:aws:kms:region:account-id:key/KMSkey&quot;
</code></pre>
<ul>
<li>逆に保存するプリンシパルは ssm:PutParameters と kms:GenerateDataKey が必要。</li>
</ul>
<hr />
<h1 id="aws-certificate-manager-acm">AWS Certificate Manager: ACM</h1>
<ul>
<li>
<p>証明書管理とデプロイ</p>
<ul>
<li>オンプレサーバや AWS の統合サービスへの証明書デプロイ</li>
</ul>
</li>
<li>
<p>統合サービス</p>
<ul>
<li>ALB/NLB, CloudFront, API Gateway, Elastic Beanstalk</li>
</ul>
</li>
<li>
<p>管理コンソールだけで証明書を管理できる</p>
<ul>
<li>プライベートキーを安全に管理できる。(プライベートキーがダウンロードできない)</li>
<li>パブリックおよびプライベート証明書を管理できる。</li>
<li>証明書はインポートするか ACM が生成するパブリック証明書 (ACM 証明書) を使用。<ul>
<li>ACM 証明書は統合サービスで無料で利用できる証明書</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img alt="" src="_attachment/image_1456.png" /></p>
<p>IAM 証明書マネージャー</p>
<ul>
<li>ACM 使えないリージョンはこれを使うらしい。</li>
<li><a href="https://docs.aws.amazon.com/ja_jp/IAM/latest/UserGuide/id_credentials_server-certs.html">https://docs.aws.amazon.com/ja_jp/IAM/latest/UserGuide/id_credentials_server-certs.html</a></li>
</ul>
<h1 id="acm-ca-acm-pca">ACM プライベート CA (ACM PCA)</h1>
<p>マネージドのプライベート認証局サービス。</p>
<p>用途に合わせた X.509 証明書を発行できる。</p>
<ul>
<li>TLS, デバイス認証, 暗号署名コード等</li>
</ul>
<p>証明書失効ステータスを取得するオンライン証明書ステータスプロトコル (OCSP) や暗号アルゴリズムも任意のものを使用できる。</p>
<p>AWS が管理する HSM で保護されているため運用とコストの負担が軽減。</p>
<p><img alt="" src="_attachment/image_1457.png" /></p>
<ul>
<li>CA 管理者 (組織の IT 管理者) は、コンソール, CLI/API で ACM プライベート CA にアクセスし、下位の発行元 CA を作成する。この下位 CA は組織内の証明書の発行に使用される。</li>
<li>CA 管理者は証明書署名リクエスト(CSR) をオンプレのルートまたは中間 CA、または AWS のルート CA に提出する。</li>
<li>ACM プライベート CA を使用するには、ルートか中間のいずれかの CA が用意されている必要がある。ACM プライベート CA は中間またはルートのプライベート CA にチェーンする。</li>
<li>組織内で信頼されているルートまたは中間 CA によって CSR が署名され ると、署名された証明書が発行元の ACM プライベート CA にインポートされる。</li>
<li>これにより、オンプレのサーバや AWS リソースで使用する証明書を発行できるようになる。</li>
</ul>
<p>ユースケース:</p>
<ul>
<li>ACM でプライベート証明書を生成して各コンテナに配布してコンテナアプリケーション間の相互認証に使用する。</li>
</ul>
<p><img alt="" src="_attachment/image_1458.png" /><img alt="" src="_attachment/image_1459.png" /></p>
<p><br></p>
</article>

    </main>
    <footer class="footer" role="contentinfo">
        <span class="footer__title" id="title">AWS - Security - KMS, Secrets Manager, ACM</span>
        <span class="footer__percentage" aria-live="polite"><span id="scrollPercentage">0%</span></span>
    </footer>
    <script src="static/script.js"></script>
</body>
</html>